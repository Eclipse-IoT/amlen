<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
 * Copyright (c) 2013-2021 Contributors to the Eclipse Foundation
 * 
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 * 
 * SPDX-License-Identifier: EPL-2.0
 */
-->
<!--
	This test will subscribing to various MQTTv5 SharedSubscriptions with various error conditions. 
	
	For MQTTv5 Shared Subscriptions, the topic filter on the subscribe has three parts:
	
	It must start with $share to cue ISM that this is a shared subscription.
	
	The next element is the Subscription Name. 
	
	Then follows the Topic filter to subscriber to.
	
	Example: 
	
	$SharedSubcription/MySubscriptionName/RiverLevels/RedRiver
	
	This test uses the DemoEndpoint, which gives Control authorization for Subscription Messaging
	policies to to all clients. 
	
-->
<IsmWSTest name="testmqtt_sharedMixv5_error01" >
	<!-- make sure the client we are about to use has no prior state --> 
	
	<!-- Create a non-clean session Connection -->
	<Action name="CreateConnection" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">true</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>	
	
	<!-- **************************************************** -->
	<!-- Section 1: This checks various illegal topic filters --> 
	<!-- **************************************************** -->
	
	<!-- invalid Topic filter. There must be a SubscriptionName and Topic --> 
	<Action name="Subscribe_NoSubName" type="Subscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topic">$share/</ApiParameter>
		<ApiParameter name="QoS">1</ApiParameter>
		<ApiParameter name="expectedrcv5">143</ApiParameter>
	</Action>
	
	<Action name="CheckConnectionGood" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    
	
	<Action name="CloseConnection0" type="CloseConnection">
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action> 	
	
	<Action name="ReCreateConnection1" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
	
	<Action name="CheckConnection1Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    	
	
	<!-- invalid Topic filter. The SubscriptionName is an empty string and Topic is missing-->
	<Action name="Subscribe_NoSubName2" type="Subscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topic">$share//</ApiParameter>
		<ApiParameter name="QoS">1</ApiParameter>
		<ApiParameter name="expectedrc">143</ApiParameter>
	</Action>
	
	<Action name="ReCreateConnection2" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
		<ApiParameter name="expectedrc">142</ApiParameter>
	</Action>
	
	<Action name="CheckConnection2Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    	
	
	<!-- invalid Topic filter. The SubscriptionName is an empty string-->
	<Action name="Subscribe_NoSubName3" type="Subscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topic">$share//SomeTopic</ApiParameter>
		<ApiParameter name="QoS">0</ApiParameter>
		<ApiParameter name="expectedrc">143</ApiParameter>
	</Action>
	
	<Action name="CheckConnection2StillGood" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    	
	
	<Action name="CloseConnection2" type="CloseConnection">
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action> 	

	
	
	<!-- **************************************************** -->
	<!-- Section 3: This checks various illegal topic filters
	 	on publish --> 
	<!-- **************************************************** -->

	<Action name="ReCreateConnection8" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>

    <Action name="CreateRandomMessage" type="CreateRandomMessage">
        <ActionParameter name="structure_id">txmsg1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="length">190</ActionParameter>
        <ApiParameter name="QoS">1</ApiParameter>
    </Action>
	
	<!-- the puback should report an error temporarily wrong until we make sure we can check 
	 the error. --> 
    <Action name="SendMessage_InvalidSharedSub" type="SendMessage">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="message_id">txmsg1</ActionParameter>
        <ActionParameter name="topic">$share/SubName/TopicName</ActionParameter>
        <!-- ApiParameter name="expectedrc">144</ApiParameter -->
        <ApiParameter name="expectedrc">14</ApiParameter>
    </Action>
    
	<Action name="CheckConnection8StillGood" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>  
	
	<Action name="CloseConnection8" type="CloseConnection">
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action> 	   

	<Action name="ReCreateConnection9" type="CreateConnection">
		<ActionParameter name="structure_id">Con9</ActionParameter>
		<ActionParameter name="connection_id">CF9</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01_9</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">true</ApiParameter>
		<ApiParameter name="sessionExpire">60</ApiParameter>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
    
	<Action name="CheckConnection9Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF9</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    
		
    <Action name="CreateRandomMessage2" type="CreateRandomMessage">
        <ActionParameter name="structure_id">txmsg1</ActionParameter>
        <ActionParameter name="connection_id">CF9</ActionParameter>
        <ActionParameter name="length">190</ActionParameter>
        <ApiParameter name="QoS">1</ApiParameter>
    </Action>
	
    <Action name="SendMessage_InvalidSharedSub2" type="SendMessage">
        <ActionParameter name="connection_id">CF9</ActionParameter>
        <ActionParameter name="message_id">txmsg1</ActionParameter>
        <ActionParameter name="topic">$share/SubNameConn9</ActionParameter>
        <ApiParameter name="expectedrc">144</ApiParameter>
    </Action>    

	<Action name="CheckConnection9StillGood" type="CheckConnection" >
		<ActionParameter name="connection_id">CF9</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>	
	</Action> 

	<Action name="CloseConnection9" type="CloseConnection">
        <ActionParameter name="connection_id">CF9</ActionParameter>
    </Action>
    		
	<Action name="ReCreateConnection10" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>	
    
	<Action name="CheckConnection10Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    
		
    <Action name="CreateRandomMessage3" type="CreateRandomMessage">
        <ActionParameter name="structure_id">txmsg1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="length">190</ActionParameter>
        <ApiParameter name="QoS">1</ApiParameter>
    </Action>

    <Action name="SendMessage_InvalidSharedSub3a" type="SendMessage">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="message_id">txmsg1</ActionParameter>
        <ActionParameter name="topic">$share/</ActionParameter>
        <ApiParameter name="expectedrc">144</ApiParameter>
    </Action>    

	<Action name="CheckConnection10Bad" type="CheckConnection" >
		<dependsOn action_id="SendMessage_InvalidSharedSub3a" interval="500"/>
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>   
	     
    <Action name="CloseConnection10" type="CloseConnection">
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>
    
   
    <!-- **************************************************** -->
	<!-- Section 5: This checks various illegal topic filters 
		when subscribing to multiple topics--> 
	<!-- **************************************************** -->
	
    
   	<Action name="ReCreateConnection11" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
	
	<Action name="CheckConnection11Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>
	
	<!-- invalid Topic filter. The SubscriptionName is an empty string-->
	<Action name="Subscribe_NoSubName11_Middle" type="Subscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topics">/validTopic:$share//SomeSpecialTopic:/AnotherValidToipc</ApiParameter>
		<ApiParameter name="QoSlist">0:0:0</ApiParameter>
		<ApiParameter name="expectedrcv5">0:143:0</ApiParameter>
	</Action>
	<Action name="CheckConnection11StillGood" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    
	
	<Action name="CloseConnection11" type="CloseConnection">
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>      	

   	<Action name="ReCreateConnection12" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
	
	<Action name="CheckConnection12Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    	
	
	<!-- invalid Topic filter. The SubscriptionName and Topic name are missing on the end -->
	<Action name="Subscribe_NoSubName12_End" type="Subscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topics">/validTopic:/AnotherValidTopic/Subtopic:$SharedSubscription/</ApiParameter>
		<ApiParameter name="QoSlist">2:2:0</ApiParameter>
		<ApiParameter name="expectedrcv5">2:2:143</ApiParameter>
	</Action>	

	<Action name="CheckConnectionStill12Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    	
 
	<Action name="CloseConnection12" type="CloseConnection">
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>      	
	
  	<Action name="ReCreateConnection13" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
	
	<Action name="CheckConnection13Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    	
	
	<!-- invalid Topic filter. The SubscriptionName is an empty string in the first topic-->
	<Action name="Subscribe_NoSubName13_Start" type="Subscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topics">$share/sharedMix_error01Subname:/validTopic:/AnotherValidTopic</ApiParameter>
		<ApiParameter name="QoSlist">0:0:0</ApiParameter>
		<ApiParameter name="expectedrcv5">143:0:0</ApiParameter>
	</Action>	

	<Action name="CheckConnection13Good-2" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    
	
	<!-- **************************************************** -->
	<!-- Section 6:  validates unsubscribes.. reconnecting a 
		client, and that cleansession=true cleans up
		DurableSubscriptions These are not strictly error 
		cases.--> 
	<!-- **************************************************** -->
   
  	<Action name="ReCreateConnection14Good" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
	
	<Action name="CheckConnection14Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    	
	
	<!-- Valid and Multiple Durable Shared and Durable Non Shared Subs Topic filters. -->
	<Action name="Subscribe_MultValidShared" type="Subscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topics">$share/sharedMix_error01Subname/Valid:/validTopic:/AnotherValidTopic:$share/sharedMix_error01Subname2//Valid2</ApiParameter>
		<ApiParameter name="QoSlist">0:1:2:2</ApiParameter>
		<ApiParameter name="expectedrcv5">0:1:2:2</ApiParameter>
	</Action>	

	<Action name="CheckConnection14Still_good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    
	
   <Action name="restShowsharedMix_error01Subname" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="Valid"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>											
	
	<Action name="restShowsharedMix_error01Subname2" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname2" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="/Valid2"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>													
	
	<Action name="restShowNonSharedSubs" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/validTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>	
    
	<Action name="compareShowNonSharedSubs2" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/AnotherValidTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>	    
    
	<Action name="CloseConnectionWithDurableSubscriptions" type="CloseConnection">
   	    <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>   
    
    <!-- Now show the subscriptions again. They should exist, but have
    	no consumers. (this is checked in comparelogs looking for 
    	the  subscriptions with consumers=0 ) --> 

   <Action name="restShowsharedMix_error01Subname_NoCons" type="RestAPI">
   		<dependsOn action_id="CloseConnectionWithDurableSubscriptions" interval="1000"/>
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="Valid"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>											

	<Action name="restShowsharedMix_error01Subname2_NoCons" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname2_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="/Valid2"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>		
    				
	<Action name="restShowNonSharedSubs_NoCons" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/validTopic"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>	
    
	<Action name="compareShowNonSharedSubs2_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/AnotherValidTopic"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>	    	 
	
	<!-- Clean session is false.. so our subscriptions should be there, and 
		I think show consumers. --> 
   	<Action name="ReCreateConnection15Good" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">false</ApiParameter>
		<include>../common/MQTTv5_durable_session.xml</include>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
	
	<Action name="CheckConnection15Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    
	
	<!-- we don't need to resubscribe. --> 
   <Action name="restShowsharedMix_error01Subname_again" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="Valid"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>			

   <Action name="restShowsharedMix_error01Subname2_again" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname2_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="/Valid2"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>			
	
	<Action name="restShowNonSharedSubs_again" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/validTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>	
    
	<Action name="compareShowNonSharedSubs2_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/AnotherValidTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>	    	
	
	<!-- try both ways of getting rid of a Durable Shared Subscription in MQTT
		Method 1 is be the last one to unsubscribe (if you you have Control authority
		which we do). -->
	<Action name="UnSubscribe_Shared1" type="Unsubscribe">
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ApiParameter name="topic">$share/sharedMix_error01Subname/Valid</ApiParameter>
	</Action>
	
   <Action name="restShowsharedMix_error01Subname_gone" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>		
	
    <Action name="compareShowsharedMix_error01Subname_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
    </Action>		
			 	
    <!-- Method 2 is to close, and reconnect with clean session. (again, you need 
    	control authority -->     	
	<Action name="CloseConnectionWithDurableSubscription" type="CloseConnection">
   	    <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>    
    
    <!-- reopen, with cleansession=true, should delete all subscriptions --> 
   	<Action name="ReCreateConnection16Good" type="CreateConnection">
		<ActionParameter name="structure_id">Con1</ActionParameter>
		<ActionParameter name="connection_id">CF1</ActionParameter>
        <include>../common/ConnectionTypeV5.xml</include>
		<include>../common/MQTT_server.xml</include>
		<ApiParameter name="clientId">sharedMix_error01</ApiParameter>
        <include>../common/MQTT_port.xml</include>
		<ApiParameter name="protocol">mqtt</ApiParameter>
		<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
		<ApiParameter name="cleanSession">true</ApiParameter>
		<ApiParameter name="sessionExpire">0</ApiParameter>
		<!-- ApiParameter name="verbose">true</ApiParameter-->
	</Action>
	
	<Action name="CheckConnection16Good" type="CheckConnection" >
		<ActionParameter name="connection_id">CF1</ActionParameter>
		<ActionParameter name="isConnected">true</ActionParameter>
	</Action>    

	<!-- These should have been removed on cleansession. --> 

	<Action name="restShowsharedMix_error01Subname2_gone" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>		
	
    <Action name="compareShowsharedMix_error01Subname2_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
    </Action>			
	
	<Action name="restShowNonSharedSubs_gone" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
    </Action>	
    
	<Action name="compareShowNonSharedSubs2_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
    </Action>	    		
	
	<Action name="Finalclose" type="CloseConnection">
   	    <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>   
    	
</IsmWSTest>
                