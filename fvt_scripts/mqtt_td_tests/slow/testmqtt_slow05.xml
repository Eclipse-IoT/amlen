<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
 * Copyright (c) 2013-2021 Contributors to the Eclipse Foundation
 * 
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 * 
 * SPDX-License-Identifier: EPL-2.0
 */
   TestCase Name: testmqtt_slow05

   Test Category: Slow MQTT

   Test Description:
   See what happens with slow subscribers and MaxMessage/DiscardMessage settings
   at mixed QoS's. 
   
   The subscribers names indicate what MaxMessages was set to. 
   
   NOTE:  The shellactions are on their own threads, so they give an approximate state of 
   the server statistics.  

  -->
<IsmWSTest name="testmqtt_slow05">

	<SyncClient>
		<server>
			<include>../common/JMS_syncip.xml</include>
			<include>../common/JMS_syncport.xml</include>
		</server>
		<solution>mqttSlow05</solution>
	</SyncClient>
  
	<Action name="Subs" type="CompositeAction">
	<!--  These CreateConnections will clear out any old client info -->
	    <Action name="CreateConnectionSub273clear" type="CreateConnection" thread="11" >
    	    <ActionParameter name="structure_id">ConSub273</ActionParameter>
	        <ActionParameter name="connection_id">CFSub273</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub273_clientid</ApiParameter>
        	<ApiParameter name="port">29301</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnection273clear" type="CloseConnection" thread="11">
    	    <ActionParameter name="connection_id">CFSub273</ActionParameter>
	    </Action>

	    <Action name="CreateConnectionSub146clear" type="CreateConnection" thread="22" >
    	    <ActionParameter name="structure_id">ConSub146</ActionParameter>
	        <ActionParameter name="connection_id">CFSub146</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub146_clientid</ApiParameter>
        	<ApiParameter name="port">29301</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnection146clear" type="CloseConnection" thread="22">
    	    <ActionParameter name="connection_id">CFSub146</ActionParameter>
	    </Action>
	    
	    <Action name="CreateConnectionSub35clear" type="CreateConnection" thread="33" >
    	    <ActionParameter name="structure_id">ConSub35</ActionParameter>
	        <ActionParameter name="connection_id">CFSub35</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub35_clientid</ApiParameter>
        	<ApiParameter name="port">29301</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnection35clear" type="CloseConnection" thread="33">
    	    <ActionParameter name="connection_id">CFSub35</ActionParameter>
	    </Action>	
	    
	    <!--  One that uses a different endpoint and doesn't have DiscardOldest set ND=NoDiscard. --> 
	    <Action name="CreateConnectionSubNoDiscardclear" type="CreateConnection" thread="44" >
    	    <ActionParameter name="structure_id">ConSub36ND</ActionParameter>
	        <ActionParameter name="connection_id">CFSub36ND</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub36ND_clientid</ApiParameter>
        	<ApiParameter name="port">29303</ApiParameter>
        	<ApiParameter name="user">MQTT_MMSUBND</ApiParameter>
			<ApiParameter name="password">password</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnectionNoDiscardclear" type="CloseConnection" thread="44">
    	    <ActionParameter name="connection_id">CFSub36ND</ActionParameter>
	    </Action>	    	        
  
  		<!-- These connections are the ones we'll use for testing --> 
		<Action name="CreateSubConnection273" type="CreateConnection" thread="11">
			<ActionParameter name="structure_id">ConSub273</ActionParameter>
			<ActionParameter name="connection_id">CFSub273</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqtt05Sub273_clientid</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">false</ApiParameter>
			<ActionParameter name="messageDelayMS">500</ActionParameter>
			<ActionParameter name="msgNodelayCount">10</ActionParameter>
			<ApiParameter name="QoS">2</ApiParameter>
  		</Action> 
  		
		<Action name="CreateSubConnection146" type="CreateConnection" thread="22">
			<ActionParameter name="structure_id">ConSub146</ActionParameter>
			<ActionParameter name="connection_id">CFSub146</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqtt05Sub146_clientid</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">false</ApiParameter>
			<ActionParameter name="messageDelayMS">400</ActionParameter>
			<ActionParameter name="msgNodelayCount">25</ActionParameter>
			<ApiParameter name="QoS">1</ApiParameter>
  		</Action>  

		<!-- at QoS=0, we won't be able to fill even this tiny queue --> 
		<Action name="CreateSubConnection35" type="CreateConnection" thread="33">
			<ActionParameter name="structure_id">ConSub35</ActionParameter>
			<ActionParameter name="connection_id">CFSub35</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqtt05Sub35_clientid</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">false</ApiParameter>
			<ActionParameter name="messageDelayMS">500</ActionParameter>
			<ActionParameter name="msgNodelayCount">25</ActionParameter>
			<ApiParameter name="QoS">0</ApiParameter>
  		</Action>    		 

		<Action name="Subscribe273_a" type="Subscribe" thread="11">
			<ActionParameter name="connection_id">CFSub273</ActionParameter>
			<ApiParameter name="topic">/MM/Slow05</ApiParameter>
			<ApiParameter name="QoS">2</ApiParameter>
		</Action>
		
		<Action name="Subscribe146_a" type="Subscribe" thread="22">
			<ActionParameter name="connection_id">CFSub146</ActionParameter>
			<ApiParameter name="topic">/MM/Slow05</ApiParameter>
			<ApiParameter name="QoS">1</ApiParameter>
		</Action>	
		
		<Action name="Subscribe35_a" type="Subscribe" thread="33">
			<ActionParameter name="connection_id">CFSub35</ActionParameter>
			<ApiParameter name="topic">/MM/Slow05</ApiParameter>
			<ApiParameter name="QoS">0</ApiParameter>
		</Action>				

		<!-- Signal to Publishers that the subscriptions are ready for messages to be sent. -->
		<Action name="sync_components_1" type="SyncComponentAction">
			<dependsOn action_id="Subscribe273_a"/>
			<dependsOn action_id="Subscribe146_a"/>
			<dependsOn action_id="Subscribe35_a"/>
			<ActionParameter name="component_name">Subs1</ActionParameter>
			<ActionParameter name="component_list">Subs1;Pubs1;JMSSub1</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>

		<Action name="CompositeReceive273_a" type="CompositeAction" repeat="500" thread="11" repeat_interval="0">
			<dependsOn action_id="sync_components_1"/>
			<Action name="ReceiveMessage273_a" type="ReceiveMessage" thread="11">
				<ActionParameter name="connection_id">CFSub273</ActionParameter>
				<ActionParameter name="structure_id">rxmsg273</ActionParameter>
				<ActionParameter name="waitTime">10000</ActionParameter>
			</Action>
		</Action>
		
		<Action name="CompositeReceive146_a" type="CompositeAction" repeat="500" thread="22" repeat_interval="0">
			<dependsOn action_id="sync_components_1"/>
			<Action name="ReceiveMessage146_a" type="ReceiveMessage" thread="22">
				<ActionParameter name="connection_id">CFSub146</ActionParameter>
				<ActionParameter name="structure_id">rxmsg146</ActionParameter>
				<ActionParameter name="waitTime">10000</ActionParameter>
			</Action>
		</Action>		

		<Action name="CompositeReceive35_a" type="CompositeAction" repeat="500" thread="33" repeat_interval="0">
			<dependsOn action_id="sync_components_1"/>
			<Action name="ReceiveMessage35_a" type="ReceiveMessage" thread="33">
				<ActionParameter name="connection_id">CFSub35</ActionParameter>
				<ActionParameter name="structure_id">rxmsg35</ActionParameter>
				<ActionParameter name="waitTime">10000</ActionParameter>
			</Action>
		</Action>	
 
		<!-- Action name="ShowSubAfterConsumers_a" type="ShellAction" thread="4">
			<dependsOn action_id="CompositeReceive273_a"/>
			<dependsOn action_id="CompositeReceive146_a"/>
			<dependsOn action_id="CompositeReceive35_a"/>
			<ActionParameter name="command">ssh ``A1_USER``@``A1_HOST`` imaserver stat Subscription</ActionParameter>
			<ActionParameter name="print_result">true</ActionParameter>
		</Action -->
		
	<Action name="ShowSubAfterConsumers_a" type="RestAPI" thread="4">
		<dependsOn action_id="CompositeReceive273_a"/>
		<dependsOn action_id="CompositeReceive146_a"/>
		<dependsOn action_id="CompositeReceive35_a"/>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>      

		<Action name="CloseSubConnection273_a" type="CloseConnection" thread="11">
			<ActionParameter name="connection_id">CFSub273</ActionParameter>
		</Action>
		
		<Action name="CloseSubConnection146_a" type="CloseConnection" thread="22">
			<ActionParameter name="connection_id">CFSub146</ActionParameter>
		</Action>		
  
		<Action name="CloseSubConnection35_a" type="CloseConnection" thread="33">
			<ActionParameter name="connection_id">CFSub35</ActionParameter>
		</Action>
  
		<!-- Action name="ShowSubAfterDisconnect1" type="ShellAction" thread="4">
			<dependsOn action_id="CloseSubConnection273_a"/>
			<dependsOn action_id="CloseSubConnection146_a"/>
			<dependsOn action_id="CloseSubConnection35_a"/>
			<ActionParameter name="command">ssh ``A1_USER``@``A1_HOST`` imaserver stat Subscription</ActionParameter>
			<ActionParameter name="print_result">true</ActionParameter>
		</Action -->
		
	<Action name="ShowSubAfterDisconnect1" type="RestAPI" thread="4">
		<dependsOn action_id="CloseSubConnection273_a"/>
		<dependsOn action_id="CloseSubConnection146_a"/>
		<dependsOn action_id="CloseSubConnection35_a"/>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>      
			
  
		<!-- Signal to Publishers that the subscribers are disconnected. -->
		<Action name="sync_components_2" type="SyncComponentAction">
			<dependsOn action_id="CloseSubConnection273_a"/>
			<dependsOn action_id="CloseSubConnection146_a"/>
			<dependsOn action_id="CloseSubConnection35_a"/>
			<ActionParameter name="component_name">Subs2</ActionParameter>
			<ActionParameter name="component_list">Subs2;Pubs2</ActionParameter>
			<ActionParameter name="timeout">120000</ActionParameter>
		</Action>  
		
		<!-- Wait for Publishers to signal that they've sent a bunch of messages while
			subscribers are disconnected. -->
		<Action name="sync_components_3" type="SyncComponentAction">
			<ActionParameter name="component_name">Subs3</ActionParameter>
			<ActionParameter name="component_list">Subs3;Pubs3</ActionParameter>
			<ActionParameter name="timeout">120000</ActionParameter>
		</Action>  		

  		<!-- Recreate the subscribers after the Publishers have sent a ton of messages to 
  		the queues while they were disconnected. No delays on receiving now. --> 
		<Action name="ReCreateSubConnection273" type="CreateConnection" thread="11">
			<dependsOn action_id="sync_components_3"/>
			<ActionParameter name="structure_id">ConSub273</ActionParameter>
			<ActionParameter name="connection_id">CFSub273</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqtt05Sub273_clientid</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">false</ApiParameter>
			<ApiParameter name="QoS">2</ApiParameter>
  		</Action> 
  		
		<Action name="ReCreateSubConnection146" type="CreateConnection" thread="22">
			<dependsOn action_id="sync_components_3"/>
			<ActionParameter name="structure_id">ConSub146</ActionParameter>
			<ActionParameter name="connection_id">CFSub146</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqtt05Sub146_clientid</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">false</ApiParameter>
			<ApiParameter name="QoS">1</ApiParameter>
  		</Action>  

		<Action name="ReCreateSubConnection35" type="CreateConnection" thread="33">
			<dependsOn action_id="sync_components_3"/>
			<ActionParameter name="structure_id">ConSub35</ActionParameter>
			<ActionParameter name="connection_id">CFSub35</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqtt05Sub35_clientid</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">false</ApiParameter>
			<ApiParameter name="QoS">0</ApiParameter>
  		</Action>    		 
  
		<!-- Action name="ShowSubAfterLastConnect" type="ShellAction" thread="4">
			<dependsOn action_id="ReCreateSubConnection273"/>
			<dependsOn action_id="ReCreateSubConnection146"/>
			<dependsOn action_id="ReCreateSubConnection35"/>
			<ActionParameter name="command">ssh ``A1_USER``@``A1_HOST`` imaserver stat Subscription</ActionParameter>
			<ActionParameter name="print_result">true</ActionParameter>
		</Action -->
		
	<Action name="ShowSubAfterLastConnect" type="RestAPI" thread="4">
		<dependsOn action_id="ReCreateSubConnection273"/>
		<dependsOn action_id="ReCreateSubConnection146"/>
		<dependsOn action_id="ReCreateSubConnection35"/>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>      	  

	  <!-- there should be between some number of messages waiting for each subscriber. The number is 
       indeterminate  because exactly what happens with an overfull queue is quite a bit
       mushy. It might delete 5% immediately, it might fail to get a lock and store the message until
       it can get the lock to delete 5%. There might have been some 'inflight' messages when
       we disconnected the consumer.. so read about 10% of the queue then verify that the last ones in the 
       queue are the oldest sent.  -->
		
		<Action name="ReceiveMessage273_c" type="ReceiveMessage" repeat="280" atleast="258" thread="11">
			<ActionParameter name="connection_id">CFSub273</ActionParameter>
			<ActionParameter name="structure_id">rxmsg273</ActionParameter>
			<ActionParameter name="waitTime">5000</ActionParameter>
		</Action>
			
		<Action name="CheckMessage273_c" type="CompareMessageData"  thread="11">
			<dependsOn action_id="ReceiveMessage273_c" interval="0" />
			<ActionParameter name="structure_id">rxmsg273</ActionParameter>
			<ActionParameter name="compareBodyStart">TEXT: test content Publisher 3c. Newest Messages. Message number: 300</ActionParameter>
		</Action>
		
		<Action name="ReceiveMessage146_c" type="ReceiveMessage" repeat="155" atleast="125" thread="22">
			<ActionParameter name="connection_id">CFSub146</ActionParameter>
			<ActionParameter name="structure_id">rxmsg146</ActionParameter>
			<ActionParameter name="waitTime">5000</ActionParameter>
		</Action>
			
		<Action name="CheckMessage146_c" type="CompareMessageData"  thread="22">
			<dependsOn action_id="ReceiveMessage146_c" interval="0" />
			<ActionParameter name="structure_id">rxmsg146</ActionParameter>
			<ActionParameter name="compareBodyStart">TEXT: test content Publisher 3c. Newest Messages. Message number: 300</ActionParameter>
		</Action>		
		
		<Action name="ReceiveMessage35_c" type="ReceiveMessage" repeat="50" atleast="25" thread="33">
			<ActionParameter name="connection_id">CFSub35</ActionParameter>
			<ActionParameter name="structure_id">rxmsg35</ActionParameter>
			<ActionParameter name="waitTime">5000</ActionParameter>
		</Action>
			
		<Action name="CheckMessage35_c" type="CompareMessageData">
			<dependsOn action_id="ReceiveMessage35_c" interval="0" />
			<ActionParameter name="structure_id">rxmsg35</ActionParameter>
			<ActionParameter name="compareBodyStart">TEXT: test content Publisher 3c. Newest Messages. Message number: 300</ActionParameter>
		</Action>
 
		<!-- Action name="ShowSubAfterConsumers_c" type="ShellAction" thread="4">
			<dependsOn action_id="CheckMessage273_c"/>
			<dependsOn action_id="CheckMessage146_c"/>
			<dependsOn action_id="CheckMessage35_c"/>
			<ActionParameter name="command">ssh ``A1_USER``@``A1_HOST`` imaserver stat Subscription</ActionParameter>
			<ActionParameter name="print_result">true</ActionParameter>
		</Action -->
		
	<Action name="ShowSubAfterConsumers_c" type="RestAPI" thread="4">
		<dependsOn action_id="CheckMessage273_c"/>
		<dependsOn action_id="CheckMessage146_c"/>
		<dependsOn action_id="CheckMessage35_c"/>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>      	 				

		<Action name="CloseSubConnection273_b" type="CloseConnection" thread="11">
			<ActionParameter name="connection_id">CFSub273</ActionParameter>
		</Action>
		
		<Action name="CloseSubConnection146_b" type="CloseConnection" thread="22">
			<ActionParameter name="connection_id">CFSub146</ActionParameter>
		</Action>		
  
		<Action name="CloseSubConnection35_b" type="CloseConnection" thread="33">
			<ActionParameter name="connection_id">CFSub35</ActionParameter>
		</Action>

		<!-- Now we make things interesting, by adding a Durable QoS=1 consumer which does not have DiscardOldMessages 
			This should cause out queues to fill up, and the publisher to disconnect. --> 

	    <Action name="CreateConnectionSubNoDiscard" type="CreateConnection" thread="44" >
			<dependsOn action_id="CheckMessage273_c"/>
			<dependsOn action_id="CheckMessage146_c"/>
			<dependsOn action_id="CheckMessage35_c"/>
    	    <ActionParameter name="structure_id">ConSub36ND</ActionParameter>
	    	<ActionParameter name="connection_id">CFSub36ND</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub36ND_clientid</ApiParameter>
        	<ApiParameter name="port">29303</ApiParameter>
        	<ApiParameter name="user">MQTT_MMSUBND</ApiParameter>
			<ApiParameter name="password">password</ApiParameter>
        	<ApiParameter name="cleanSession">false</ApiParameter>
	    </Action>

		<Action name="SubscribeNoDiscard" type="Subscribe" thread="44">
			<ActionParameter name="connection_id">CFSub36ND</ActionParameter>
			<ApiParameter name="topic">/MM/Slow05</ApiParameter>
			<ApiParameter name="QoS">1</ApiParameter>
		</Action>	

		<Action name="CloseSubConnectionNoDiscard" type="CloseConnection" thread="44">
			<ActionParameter name="connection_id">CFSub36ND</ActionParameter>
		</Action>

		<!-- Signal for a Publisher to send messages that overfill the queue, now that we have a 
			wildchild (noDiscard) consumer.  -->
		<Action name="sync_components_4" type="SyncComponentAction">
			<dependsOn action_id="CloseSubConnectionNoDiscard"/>
			<ActionParameter name="component_name">Subs4</ActionParameter>
			<ActionParameter name="component_list">Subs4;Pubs4</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>  	

		<!-- Wait for the Publisher to finish. --> 
		<Action name="sync_components_5" type="SyncComponentAction">
			<ActionParameter name="component_name">Subs5</ActionParameter>
			<ActionParameter name="component_list">Subs5;Pubs5</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>  	
		
		<!-- do we need to verify that we are not getting old messages??  -->
		<!-- I think not, since the publish should fail.. but ??? --> 
		
		<!-- and finally clean up all the subscriptions --> 
		

		<!--  These CreateConnections will clear out any old client info -->
	    <Action name="CreateConnectionSub273reclear" type="CreateConnection" thread="11" >
	    	<dependsOn action_id="sync_components_5"/>
    	    <ActionParameter name="structure_id">ConSub273</ActionParameter>
	        <ActionParameter name="connection_id">CFSub273</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub273_clientid</ApiParameter>
        	<ApiParameter name="port">29301</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnection273reclear" type="CloseConnection" thread="11">
    	    <ActionParameter name="connection_id">CFSub273</ActionParameter>
	    </Action>

	    <Action name="CreateConnectionSub146reclear" type="CreateConnection" thread="22" >
	    	<dependsOn action_id="sync_components_5"/>
    	    <ActionParameter name="structure_id">ConSub146</ActionParameter>
	        <ActionParameter name="connection_id">CFSub146</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub146_clientid</ApiParameter>
        	<ApiParameter name="port">29301</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnection146reclear" type="CloseConnection" thread="22">
    	    <ActionParameter name="connection_id">CFSub146</ActionParameter>
	    </Action>
	    
	    <Action name="CreateConnectionSub35reclear" type="CreateConnection" thread="33" >
	    	<dependsOn action_id="sync_components_5"/>
    	    <ActionParameter name="structure_id">ConSub35</ActionParameter>
	        <ActionParameter name="connection_id">CFSub35</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub35_clientid</ApiParameter>
        	<ApiParameter name="port">29301</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnection35reclear" type="CloseConnection" thread="33">
    	    <ActionParameter name="connection_id">CFSub35</ActionParameter>
	    </Action>	
	    
	    <!-- using a different endpoint even. --> 
	    <Action name="CreateConnectionSubNoDiscardreclear" type="CreateConnection" thread="44" >
	    	<dependsOn action_id="sync_components_5"/>
    	    <ActionParameter name="structure_id">ConSub36ND</ActionParameter>
	        <ActionParameter name="connection_id">CFSub36ND</ActionParameter>
            <include>../common/ConnectionType.xml</include>
    	    <include>../common/MQTT_server.xml</include>
	        <ApiParameter name="clientId">mqtt05Sub36ND_clientid</ApiParameter>
        	<ApiParameter name="port">29303</ApiParameter>
        	<ApiParameter name="user">MQTT_MMSUBND</ApiParameter>
			<ApiParameter name="password">password</ApiParameter>
        	<ApiParameter name="cleanSession">true</ApiParameter>
	    </Action>
	    <Action name="CloseConnectionNoDiscardreclear" type="CloseConnection" thread="44">
    	    <ActionParameter name="connection_id">CFSub36ND</ActionParameter>
	    </Action>	    	        
	</Action>   <!-- End of Subscribers Section --> 
  
	<Action name="Pubs" type="CompositeAction">
 
		<Action name="CreatePubConnection1" type="CreateConnection" thread="11">
			<ActionParameter name="structure_id">ConPub1</ActionParameter>
			<ActionParameter name="connection_id">CFPub1</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqttslow05_clientidPub1</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">true</ApiParameter>
		</Action>
		
		<Action name="CreatePubConnection2" type="CreateConnection" thread="22">
			<ActionParameter name="structure_id">ConPub2</ActionParameter>
			<ActionParameter name="connection_id">CFPub2</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqttslow05_clientidPub2</ApiParameter>
			<ApiParameter name="port">29301</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">true</ApiParameter>
		</Action>
		
		<!-- Use a different Endpoint --> 
		<Action name="CreatePubConnection3" type="CreateConnection" thread="33">
			<ActionParameter name="structure_id">ConPub3</ActionParameter>
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<include>../common/ConnectionType.xml</include>
			<include>../common/MQTT_server.xml</include>
			<ApiParameter name="clientId">mqttslow05_clientidPub3</ApiParameter>
			<ApiParameter name="port">29303</ApiParameter>
			<ApiParameter name="user">MQTT_MMPUB</ApiParameter>
			<ApiParameter name="password">password</ApiParameter>
			<ApiParameter name="protocol">mqtt</ApiParameter>
			<ApiParameter name="path">config.ism.ibm.com</ApiParameter>
			<ApiParameter name="cleanSession">true</ApiParameter>
		</Action>
		
		<Action name="CreateMessage1a" type="CreateMessage" thread="11">
			<ActionParameter name="structure_id">txmsg1a</ActionParameter>
			<ActionParameter name="connection_id">CFPub1</ActionParameter>
			<ApiParameter name="msgType">TEXT</ApiParameter>
			<ApiParameter name="payload">TEXT: test content Publisher 1a Message number: </ApiParameter>
			<ActionParameter name="incrementing">true</ActionParameter>
		</Action>
		
		<Action name="CreateMessage2a" type="CreateMessage" thread="22">
			<ActionParameter name="structure_id">txmsg2a</ActionParameter>
			<ActionParameter name="connection_id">CFPub2</ActionParameter>
			<ApiParameter name="msgType">TEXT</ApiParameter>
			<ApiParameter name="payload">TEXT: test content Publisher 2a Message number: </ApiParameter>
			<ActionParameter name="incrementing">true</ActionParameter>
		</Action>
		
		<Action name="CreateMessage3a" type="CreateMessage" thread="33">
			<ActionParameter name="structure_id">txmsg3a</ActionParameter>
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ApiParameter name="msgType">TEXT</ApiParameter>
			<ApiParameter name="payload">TEXT: test content Publisher 3a Message number: </ApiParameter>
			<ActionParameter name="incrementing">true</ActionParameter>
		</Action>	
		
		<Action name="CreateMessage1b" type="CreateMessage" thread="11">
			<ActionParameter name="structure_id">txmsg1b</ActionParameter>
			<ActionParameter name="connection_id">CFPub1</ActionParameter>
			<ApiParameter name="msgType">TEXT</ApiParameter>
			<ApiParameter name="payload">TEXT: test content Publisher 1b Message number: </ApiParameter>
			<ActionParameter name="incrementing">true</ActionParameter>
		</Action>
		
		<Action name="CreateMessage2b" type="CreateMessage" thread="22">
			<ActionParameter name="structure_id">txmsg2b</ActionParameter>
			<ActionParameter name="connection_id">CFPub2</ActionParameter>
			<ApiParameter name="msgType">TEXT</ApiParameter>
			<ApiParameter name="payload">TEXT: test content Publisher 2b Message number: </ApiParameter>
			<ActionParameter name="incrementing">true</ActionParameter>
		</Action>
		
		<Action name="CreateMessage3b" type="CreateMessage" thread="33">
			<ActionParameter name="structure_id">txmsg3b</ActionParameter>
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ApiParameter name="msgType">TEXT</ApiParameter>
			<ApiParameter name="payload">TEXT: test content Publisher 3b Message number: </ApiParameter>
			<ActionParameter name="incrementing">true</ActionParameter>
		</Action>	
		
		<Action name="CreateMessage3c" type="CreateMessage" thread="33">
			<ActionParameter name="structure_id">txmsg3c</ActionParameter>
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ApiParameter name="msgType">TEXT</ApiParameter>
			<ApiParameter name="payload">TEXT: test content Publisher 3c. Newest Messages. Message number: </ApiParameter>
			<ActionParameter name="incrementing">true</ActionParameter>
		</Action>						
		
		<!-- Signal from the subscribers subscriptions are ready for messages to be sent. -->
		<Action name="sync_components_1" type="SyncComponentAction">
			<dependsOn action_id="CreateMessage1a"/>
			<dependsOn action_id="CreateMessage2a"/>
			<dependsOn action_id="CreateMessage3a"/>
			<ActionParameter name="component_name">Pubs1</ActionParameter>
			<ActionParameter name="component_list">Subs1;Pubs1;JMSSub1</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>					
  
		<Action name="SendMessage_1a" type="SendMessage" interval="0" repeat="2000" thread="11" repeat_interval="2">
	 	  	<dependsOn action_id="sync_components_1" interval="0" />
			<ActionParameter name="connection_id">CFPub1</ActionParameter>
			<ActionParameter name="message_id">txmsg1a</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">2</ActionParameter>
		</Action>
		
		<Action name="SendMessage_2a" type="SendMessage" interval="0" repeat="2000" thread="22" repeat_interval="4">
	 	  	<dependsOn action_id="sync_components_1" interval="0" />
			<ActionParameter name="connection_id">CFPub2</ActionParameter>
			<ActionParameter name="message_id">txmsg2a</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">1</ActionParameter>
		</Action>	
		
		<Action name="SendMessage_3a" type="SendMessage" interval="0" repeat="2000" thread="33" repeat_interval="6">
	 	  	<dependsOn action_id="sync_components_1" interval="0" />
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ActionParameter name="message_id">txmsg3a</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">1</ActionParameter>
		</Action>
		
		<!-- Wait for signal that the subscribers disconnected.. -->
		<Action name="sync_components_2" type="SyncComponentAction">
			<dependsOn action_id="SendMessage_1a"/>
			<dependsOn action_id="SendMessage_2a"/>
			<dependsOn action_id="SendMessage_3a"/>
			<ActionParameter name="component_name">Pubs2</ActionParameter>
			<ActionParameter name="component_list">Subs2;Pubs2</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>						

		<!-- Action name="ShowSubAfterPublish" type="ShellAction" thread="4">
			<dependsOn action_id="sync_components_2"/>
			<ActionParameter name="command">ssh ``A1_USER``@``A1_HOST`` imaserver stat Subscription</ActionParameter>
			<ActionParameter name="print_result">true</ActionParameter>
		</Action -->
		
	<Action name="ShowSubAfterPublish" type="RestAPI" thread="4">
		<dependsOn action_id="sync_components_2"/>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>   	
		
		<Action name="SendMessage_1b" type="SendMessage" interval="0" repeat="2000" thread="11" repeat_interval="2">
	 	  	<dependsOn action_id="sync_components_2" interval="0" />
			<ActionParameter name="connection_id">CFPub1</ActionParameter>
			<ActionParameter name="message_id">txmsg1b</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">2</ActionParameter>
		</Action>
		
		<Action name="SendMessage_2b" type="SendMessage" interval="0" repeat="2000" thread="22" repeat_interval="4">
	 	  	<dependsOn action_id="sync_components_2" interval="0" />
			<ActionParameter name="connection_id">CFPub2</ActionParameter>
			<ActionParameter name="message_id">txmsg2b</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">1</ActionParameter>
		</Action>	
		
		<Action name="SendMessage_3b" type="SendMessage" interval="0" repeat="2000" thread="33" repeat_interval="6">
	 	  	<dependsOn action_id="sync_components_2" interval="0" />
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ActionParameter name="message_id">txmsg3b</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">1</ActionParameter>
		</Action>	
		
		<Action name="SendMessage_3c" type="SendMessage" interval="0" repeat="300" thread="33" repeat_interval="0">
	 	  	<dependsOn action_id="SendMessage_1b" interval="0" />
	 	  	<dependsOn action_id="SendMessage_2b" interval="0" />
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ActionParameter name="message_id">txmsg3c</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">1</ActionParameter>
		</Action>	
		
		<!-- Signal Subscribers to reconnect and get the newest messages.. -->
		<Action name="sync_components_3" type="SyncComponentAction">
			<dependsOn action_id="SendMessage_3c"/>
			<ActionParameter name="component_name">Pubs3</ActionParameter>
			<ActionParameter name="component_list">Subs3;Pubs3</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>						
	
		<Action name="ClosePubConnection1" type="CloseConnection" thread="11" >
			<ActionParameter name="connection_id">CFPub1</ActionParameter>
  		</Action>
  		
  		<Action name="ClosePubConnection2" type="CloseConnection" thread="22" >
			<ActionParameter name="connection_id">CFPub2</ActionParameter>
  		</Action>

		<!-- Subscribers are done getting their messages, and there's a new subscriber, 
			a wildchild (noDiscard) consumer. See what happens when we exceed their MaxMessage sizes.   -->
		<Action name="sync_components_4" type="SyncComponentAction">
			<ActionParameter name="component_name">Pubs4</ActionParameter>
			<ActionParameter name="component_list">Subs4;Pubs4</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>  
		
		<!-- Action name="ShowSubsAfterPublishtoDisconnectedClient" type="ShellAction" thread="4">
			<dependsOn action_id="sync_components_4" interval="0" />
			<ActionParameter name="command">ssh ``A1_USER``@``A1_HOST`` imaserver stat Subscription</ActionParameter>
			<ActionParameter name="print_result">true</ActionParameter>
		</Action -->
		
	<Action name="ShowSubsAfterPublishtoDisconnectedClient" type="RestAPI" thread="4">
		<dependsOn action_id="sync_components_4" interval="0" />
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>   		   
			
		<!-- The wildchild should cause a message to be rejected when its queue fills, and disconnect publisher -->
		<Action name="SendMoreMessage_3c" type="SendMessage" interval="0" repeat="300" atleast="36" thread="33" repeat_interval="0">
	 	  	<dependsOn action_id="sync_components_4" interval="0" />
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ActionParameter name="message_id">txmsg3c</ActionParameter>
			<ActionParameter name="topic">/MM/Slow05</ActionParameter>
			<ActionParameter name="QoS">1</ActionParameter>
		</Action>	
		
		<Action name="CheckConnection_Pub3" type="CheckConnection" thread="33" >
			<ActionParameter name="connection_id">CFPub3</ActionParameter>
			<ActionParameter name="isConnected">false</ActionParameter>
		</Action>
		
		<!-- Action name="ShowSubsAfterPublishtoWildChild" type="ShellAction" thread="4">
			<dependsOn action_id="SendMoreMessage_3c" interval="0" />
			<ActionParameter name="command">ssh ``A1_USER``@``A1_HOST`` imaserver stat Subscription</ActionParameter>
			<ActionParameter name="print_result">true</ActionParameter>
		</Action -->
		
	<Action name="ShowSubsAfterPublishtoWildChild" type="RestAPI" thread="4">
		<ActionParameter name="structureID">stat_output_Final</ActionParameter>
		<dependsOn action_id="SendMoreMessage_3c" interval="0" />
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action> 

   <Action name="compareSubs_mqtt05Sub273_clientid" type="CompareREST" thread="4">
        <ActionParameter name="structureID">stat_output_Final</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/MM/Slow05</ActionParameter>
        <ActionParameter name="subObjectKeyB">ClientID</ActionParameter>
        <ActionParameter name="subObjectNameB">mqtt05Sub273_clientid</ActionParameter>
        <ObjectProperty name="BufferedHWMPercent" value="REGEXP: 1[0-9]+.[0-9]"/>
        <ObjectProperty name="MaxMessages" value="273"/>
        <ObjectProperty name="IsDurable" value="true"/>
        <ObjectProperty name="RejectedMsgs" value="0"/>
        <ObjectProperty name="DiscardedMsgs" value="REGEXP: [1-9][0-9]+"/>
    </Action>	
    			 		   
  <Action name="compareSubs_mqtt05Sub146_clientid" type="CompareREST" thread="4">
        <ActionParameter name="structureID">stat_output_Final</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/MM/Slow05</ActionParameter>
        <ActionParameter name="subObjectKeyB">ClientID</ActionParameter>
        <ActionParameter name="subObjectNameB">mqtt05Sub146_clientid</ActionParameter>
        <ObjectProperty name="BufferedHWMPercent" value="REGEXP: 1[0-9]+.[0-9]"/>
        <ObjectProperty name="MaxMessages" value="146"/>
        <ObjectProperty name="IsDurable" value="true"/>
        <ObjectProperty name="RejectedMsgs" value="0"/>
        <ObjectProperty name="DiscardedMsgs" value="REGEXP: [1-9][0-9]+"/>
    </Action>		
    
 	<Action name="compareSubs_mqtt05Sub35_clientid" type="CompareREST" thread="4">
        <ActionParameter name="structureID">stat_output_Final</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/MM/Slow05</ActionParameter>
        <ActionParameter name="subObjectKeyB">ClientID</ActionParameter>
        <ActionParameter name="subObjectNameB">mqtt05Sub35_clientid</ActionParameter>
        <ObjectProperty name="BufferedHWMPercent" value="REGEXP: 1[0-9]+.[0-9]"/>
        <ObjectProperty name="MaxMessages" value="35"/>
        <ObjectProperty name="IsDurable" value="true"/>
        <ObjectProperty name="RejectedMsgs" value="0"/>
        <ObjectProperty name="DiscardedMsgs" value="REGEXP: [1-9][0-9]+"/>
    </Action>	
    
 <Action name="compareSubs_mqtt05Sub36ND_clientid" type="CompareREST" thread="4">
        <ActionParameter name="structureID">stat_output_Final</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/MM/Slow05</ActionParameter>
        <ActionParameter name="subObjectKeyB">ClientID</ActionParameter>
        <ActionParameter name="subObjectNameB">mqtt05Sub36ND_clientid</ActionParameter>
        <ObjectProperty name="BufferedHWMPercent" value="REGEXP: 1[0-9]+.[0-9]"/>
        <ObjectProperty name="MaxMessages" value="36"/>
        <ObjectProperty name="IsDurable" value="true"/>
        <ObjectProperty name="DiscardedMsgs" value="0"/>
        <ObjectProperty name="RejectedMsgs" value="REGEXP: [1-9]"/>
    </Action>			    		    		 		   
						
 
 		<!-- if we are lucky enough to get this far.. tell the subscibers to clean up. Test over. -->
		<Action name="sync_components_5" type="SyncComponentAction">
			<dependsOn action_id="ShowSubsAfterPublishtoWildChild" interval="0" />
			<ActionParameter name="component_name">Pubs5</ActionParameter>
			<ActionParameter name="component_list">Subs5;Pubs5</ActionParameter>
			<ActionParameter name="timeout">60000</ActionParameter>
		</Action>  
    </Action>
</IsmWSTest>


