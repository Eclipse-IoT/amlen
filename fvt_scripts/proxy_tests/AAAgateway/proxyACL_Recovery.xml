<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
 * Copyright (c) 2016-2021 Contributors to the Eclipse Foundation
 * 
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 * 
 * SPDX-License-Identifier: EPL-2.0
 */
-->
<IsmWSTest name="proxyACL_Recovery" >
<!--
Section 1: - - - - - -   Device Pub, Application Sub - - - - - - 
    Device publishes to 'iot-2/topic' with RETAIN:true
	Application subscribes to 'iot-2/topic/+/..' Durable Wild Card Subscribe QoS:1, and receives as RETAIN:true
    Device publishes twice to 'iot-2/topic/b' with RETAIN, QoS:1 and QoS:2
	Application receives each msg since Durable Subscription, RETAIN:false, QoS:1
    Device publishes to 'iot-2//topic/c' with RETAIN:false, QoS:0
	Application receives each msg QoS:0

Section 2: - - - - - -   Application Pub, Device Sub - - - - - - 
    Application publishes to 'iot-2/topic' with RETAIN:true
	Device subscribes to 'iot-2/topic/+/..' Durable Wild Card Subscribe QoS:1, and receives as RETAIN:true
    Application publishes twice to 'iot-2/topic/b' with RETAIN, QoS:1 and QoS:2
	Device receives each msg since Durable Subscription, RETAIN:false, QoS:1
    Application publishes to 'iot-2//topic/c' with RETAIN:false, QoS:0
	Device receives each msg QoS:0



ASSUMES IoT2 Rules:  where ~ is anything but a + wildcard

DEVICE : d:<ORGNAME>:<DeviceTYPE>:<DeviceID>
Pub:  iot-2/evt/~/fmt/~
Sub:  iot-2/cmd/+/fmt/+ , iot-2/mon , iot-2/notify

APPLICATION : a:<ORGNAME>:<APPID>
Pub: iot-2/type/~/id/~/[evt|cmd]/~/fmt/~
Sub: iot-2/type/+/id/+/[evt|cmd]/+/fmt/+ , iot-2/type/+/id/+/mon , iot-2/app/+/mon

-->
    <SyncClient>
        <server>
            <include>../common/JMS_syncip.xml</include>
            <include>../common/JMS_syncport.xml</include>
        </server>
        <solution>proxyACL_Recovery</solution>
    </SyncClient>

<!-- S E C T I O N : 1  -->
    
    <!--  Tx: d:Org1:deviceType1:00123    -->
    <Action name="d:Org1:deviceType1:00123" type="CompositeAction">
        <Action name="syncReset" type="SyncAction">
            <ActionParameter name="request">reset</ActionParameter>
        </Action>


        <!-- Make sure no RETAINed messages in MS that would unexpectedly be received -->

        <Action name="CreateConnectionMS" type="CreateConnection">
            <ActionParameter name="structure_id">Con0</ActionParameter>
            <ActionParameter name="connection_id">CF0</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/MQTT_server.xml</include>
            <ApiParameter name="clientId">d:Org1:deviceType1:00123</ApiParameter>
            <include>../common/MQTT_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="DeleteAllRetained" type="DeleteAllRetainedMessages">
            <ActionParameter name="connection_id">CF0</ActionParameter>
        </Action>

        <Action name="CloseConnectionMS" type="CloseConnection">
            <ActionParameter name="connection_id">CF0</ActionParameter>
        </Action>

        <Action name="sync_0" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx0</ActionParameter>
            <ActionParameter name="component_list">rx0;tx0</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

        <Action name="CreateConnection0" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org1:deviceType1:00123</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>
        <Action name="CloseConnection0" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

        <Action name="CreateConnection1" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org1:deviceType1:00123</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>

        <Action name="CreateMessage1" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="msgType">TEXT</ApiParameter>
            <ApiParameter name="payload">Just some random TEXT to RETAIN</ApiParameter>
        </Action>
        <Action name="CreateMessage2" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg2</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="msgType">JSON</ApiParameter>
            <ApiParameter name="payload">{"Message":"Just some random JSON to RETAIN"}</ApiParameter>
        </Action>

        <Action name="SendMessage1" type="SendMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="message_id">txmsg1</ActionParameter>
            <ActionParameter name="topic">iot-2/evt/RETAIN1/fmt/txt</ActionParameter>
            <ActionParameter name="QoS">1</ActionParameter>
            <ActionParameter name="RETAIN">true</ActionParameter>
        </Action>
        <Action name="SendMessage2" type="SendMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="message_id">txmsg2</ActionParameter>
            <ActionParameter name="topic">iot-2/evt/RETAIN2/fmt/json</ActionParameter>
            <ActionParameter name="QoS">2</ActionParameter>
            <ActionParameter name="RETAIN">true</ActionParameter>
        </Action>

        <Action name="sync_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx1</ActionParameter>
            <ActionParameter name="component_list">rx1;tx1</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>


        <Action name="CreateMessage3" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg3</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="msgType">JSON</ApiParameter>
            <ApiParameter name="payload">{"Message":"Just some random JSON here for Messages in a Batch of 20"}</ApiParameter>
        </Action>


        <Action name="sync_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2</ActionParameter>
            <ActionParameter name="component_list">rx2;tx2</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

<!--  Sometimes the CLOSE was getting an error about Pending Msg Ack?
        <Action name="WaitForPubAcks" type="CheckPendingDeliveryTokens">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
        <Action name="CloseConnection1" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

        <Action name="CreateConnection2" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org1:deviceType1:00123</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>
  -->

        <Action name="SendBatchMessage3.1" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="SendMessage3.1" type="SendMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="message_id">txmsg3</ActionParameter>
                <ActionParameter name="topic">iot-2/evt/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="QoS">2</ActionParameter>
                <ActionParameter name="RETAIN">false</ActionParameter>
            </Action>
        </Action>


        <Action name="sync_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx3</ActionParameter>
            <ActionParameter name="component_list">rx3;tx3</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>


        <Action name="SendBatchMessage3.2" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="SendMessage3.2" type="SendMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="message_id">txmsg3</ActionParameter>
                <ActionParameter name="topic">iot-2/evt/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="QoS">2</ActionParameter>
                <ActionParameter name="RETAIN">false</ActionParameter>
                <ActionParameter name="waitForAck">true</ActionParameter>
                <ActionParameter name="waitTime">1000</ActionParameter>
            </Action>
        </Action>
        <Action name="WaitForPubAcks" type="CheckPendingDeliveryTokens">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>


        <Action name="sync_4" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx4</ActionParameter>
            <ActionParameter name="component_list">rx4;tx4</ActionParameter>
            <ActionParameter name="timeout">45000</ActionParameter>
        </Action>

        
<!-- Proxy drops MQTT Connections when A1 Server restarts, must reconnect, actually close is not necessary?  -->        

        <Action name="CloseConnection2" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>


        <Action name="sync_5" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx5</ActionParameter>
            <ActionParameter name="component_list">rx5;tx5</ActionParameter>
            <ActionParameter name="timeout">75000</ActionParameter>
        </Action>
        <Action name="sync_6" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx6</ActionParameter>
            <ActionParameter name="component_list">rx6;tx6</ActionParameter>
            <ActionParameter name="timeout">90000</ActionParameter>
        </Action>
        
        <Action name="CreateConnectionCleanUp" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org1:deviceType1:00123</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="CloseConnectionCleanUp" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

    </Action>



    <!--  Rx: a:Org1:appType1    -->
    <Action name="a:Org1:appType1" type="CompositeAction">

        <Action name="CreateConnection0" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org1:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>
        <Action name="CloseConnection0" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
        
        <Action name="sync_0" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx0</ActionParameter>
            <ActionParameter name="component_list">rx0;tx0</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>


        <Action name="sync_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx1</ActionParameter>
            <ActionParameter name="component_list">rx1;tx1</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>



<!-- Sleep Allows for RETAIN to be processed on Pub side so Subscribe will receive-->
        <Action name="WaitForRetainProcessingAtPub" type="Sleep">
            <ActionParameter name="waitTime">1000</ActionParameter>
        </Action>

        <Action name="CreateConnection1" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org1:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>

        <Action name="Subscribe_Retain1" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/type/+/id/+/evt/RETAIN1/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
        </Action>
        <Action name="Subscribe_DuraTopic" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/type/+/id/+/evt/DuraTopic/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
        </Action>
        <Action name="Subscribe_mon" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/type/+/id/+/mon</ApiParameter>
            <ApiParameter name="QoS">0</ApiParameter>
        </Action>
        <Action name="Subscribe_appmon" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/app/+/mon</ApiParameter>
            <ApiParameter name="QoS">0</ApiParameter>
        </Action>

        <Action name="ReceiveMessage1" type="ReceiveMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">15000</ActionParameter>
        </Action>
        <Action name="CheckMessage1" type="CompareMessageData">
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="compareBody">Just some random TEXT to RETAIN</ActionParameter>
            <ActionParameter name="compareTopic">iot-2/type/deviceType1/id/00123/evt/RETAIN1/fmt/txt</ActionParameter>
            <ActionParameter name="compareQoS">1</ActionParameter>
            <ActionParameter name="compareRetain">true</ActionParameter>
        </Action>
        <Action name="ReceiveNoMore1" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>

        <Action name="CloseConnection1" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>



        <Action name="sync_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2</ActionParameter>
            <ActionParameter name="component_list">rx2;tx2</ActionParameter>
            <ActionParameter name="timeout">3000</ActionParameter>
        </Action>

		
        <Action name="CreateConnection2" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org1:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>

        <Action name="ReceiveMessages3.1" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="ReceiveMessage3.1" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <Action name="CheckMessage3.1" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="compareBody">{"Message":"Just some random JSON here for Messages in a Batch of 20"}</ActionParameter>
                <ActionParameter name="compareTopic">iot-2/type/deviceType1/id/00123/evt/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="compareQoS">2</ActionParameter>
                <ActionParameter name="compareRetain">false</ActionParameter>
            </Action>
        </Action>

        <Action name="ReceiveNoMore3.1" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>
<!-- Proxy will Drop MQTT Connections when A1 is restarted in sync4 -->		
        <Action name="CloseConnection2_redo" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>


        <Action name="sync_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx3</ActionParameter>
            <ActionParameter name="component_list">rx3;tx3</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

<!-- TX is buffering 20 more msgs on Durable Subscription topic -->

        <Action name="sync_4" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx4</ActionParameter>
            <ActionParameter name="component_list">tx4;rx4;rx2-4;tx2-4</ActionParameter>
            <ActionParameter name="timeout">45000</ActionParameter>
        </Action>
        
<!--  RESTART A1 HERE -->
<!--  These RESTART commands are successful, yet it takes a long time before client can reconnect. 30secs (store-starting) -->
<!-- 
   	<Action name="restartA1Server" type="RestAPI">
            <ActionParameter name="structureID">rest_response</ActionParameter>
            <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/v1/service/restart</ActionParameter>
            <ActionParameter name="action">POST</ActionParameter>
            <ActionParameter name="payload">{"Service":"Server"}</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
            <ActionParameter name="expectedMessageCode">CWLNA6011</ActionParameter>
        </Action>
 -->

        <Action name="RestartA1Server" type="ShellAction">
            <ActionParameter name="command">../scripts/serverControl.sh -a restartServer -i 1</ActionParameter>
            <ActionParameter name="print_result">true</ActionParameter>
        </Action>         

        <Action name="WaitForA1Restart" type="Sleep">
            <ActionParameter name="waitTime">30000</ActionParameter>
        </Action>

        <Action name="StatusA1" type="RestAPI">
            <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
            <ActionParameter name="expectedMessageCode"></ActionParameter>
        </Action>

        
        <Action name="sync_5" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx5</ActionParameter>
            <ActionParameter name="component_list">rx5;tx5;rx2-5;tx2-5</ActionParameter>
            <ActionParameter name="timeout">75000</ActionParameter>
        </Action>
        
		
<!-- Proxy drops MQTT Connections when A1 Server restarts, must reconnect  -->

        <Action name="CreateConnection2_redo" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org1:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>

        <Action name="ReceiveMessages3.2" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="ReceiveMessage3.2" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">30000</ActionParameter>
            </Action>
            <Action name="CheckMessage3.2" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="compareBody">{"Message":"Just some random JSON here for Messages in a Batch of 20"}</ActionParameter>
                <ActionParameter name="compareTopic">iot-2/type/deviceType1/id/00123/evt/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="compareQoS">2</ActionParameter>
                <ActionParameter name="compareRetain">false</ActionParameter>
            </Action>
        </Action>
        <Action name="ReceiveNoMore3.2" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>

        <Action name="Subscribe_Retain2" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/type/+/id/+/evt/RETAIN2/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
        </Action>
        <Action name="ReceiveMessage2" type="ReceiveMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>
        <Action name="CheckMessage2" type="CompareMessageData">
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="compareBody">{"Message":"Just some random JSON to RETAIN"}</ActionParameter>
            <ActionParameter name="compareTopic">iot-2/type/deviceType1/id/00123/evt/RETAIN2/fmt/json</ActionParameter>
            <ActionParameter name="compareQoS">2</ActionParameter>
            <ActionParameter name="compareRetain">true</ActionParameter>
        </Action>
        <Action name="ReceiveNoMoreRetain2" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>

        
        <Action name="sync_6" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx6</ActionParameter>
            <ActionParameter name="component_list">rx6;tx6</ActionParameter>
            <ActionParameter name="timeout">90000</ActionParameter>
        </Action>

        <Action name="CloseConnection2" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
        
        


        <!-- Clear out the durable subscription -->
        <Action name="CreateConnectionCleanup" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org1:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="CloseConnectionCleanup" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
    </Action>


<!-- * * * * * * * * * * * *   S E C T I O N : 2  * * * * * * * * * * * *  -->
    
    <!--  Tx: a:Org2:appType1    -->

    <Action name="a:Org2:appType1" type="CompositeAction">

        <Action name="sync_0" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2-0</ActionParameter>
            <ActionParameter name="component_list">rx2-0;tx2-0</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

        <Action name="CreateConnection0" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org2:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>
        <Action name="CloseConnection0" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

        <Action name="CreateConnection1" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org2:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>
        <Action name="CreateMessage1" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="msgType">TEXT</ApiParameter>
            <ApiParameter name="payload">Application CMD Message RETAIN1 in TEXT</ApiParameter>
        </Action>
        <Action name="SendMessage1_CMD" type="SendMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="message_id">txmsg1</ActionParameter>
            <ActionParameter name="topic">iot-2/type/deviceTypeX/id/deviceTX-66/cmd/RETAIN1/fmt/txt</ActionParameter>
            <ActionParameter name="QoS">2</ActionParameter>
            <ActionParameter name="RETAIN">true</ActionParameter>
        </Action>

        <Action name="CreateMessage2" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg2</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="msgType">JSON</ApiParameter>
            <ApiParameter name="payload">{"Message":"Application CMD Message RETAIN2 in JSON"}</ApiParameter>
        </Action>
        <Action name="SendMessage2_CMD" type="SendMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="message_id">txmsg2</ActionParameter>
            <ActionParameter name="topic">iot-2/type/deviceTypeX/id/deviceTX-66/cmd/RETAIN2/fmt/json</ActionParameter>
            <ActionParameter name="QoS">2</ActionParameter>
            <ActionParameter name="RETAIN">true</ActionParameter>
        </Action>


        <Action name="sync_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2-1</ActionParameter>
            <ActionParameter name="component_list">rx2-1;tx2-1</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

		
        <Action name="CreateMessage3" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg3</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="msgType">JSON</ApiParameter>
            <ApiParameter name="payload">{"Message":"Just some random JSON here for Message 3"}</ApiParameter>
        </Action>


        <Action name="sync_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2-2</ActionParameter>
            <ActionParameter name="component_list">rx2-2;tx2-2</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>
		
		
        <Action name="SendBatchMessages3-1" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="SendMessage3-1" type="SendMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="message_id">txmsg3</ActionParameter>
                <ActionParameter name="topic">iot-2/type/deviceTypeX/id/deviceTX-66/cmd/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="QoS">0</ActionParameter>
                <ActionParameter name="RETAIN">false</ActionParameter>
            </Action>
        </Action>

		
        <Action name="sync_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2-3</ActionParameter>
            <ActionParameter name="component_list">rx2-3;tx2-3</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

		
        <Action name="SendBatchMessages3-2" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="SendMessage3-2" type="SendMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="message_id">txmsg3</ActionParameter>
                <ActionParameter name="topic">iot-2/type/deviceTypeX/id/deviceTX-66/cmd/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="QoS">1</ActionParameter>
                <ActionParameter name="RETAIN">false</ActionParameter>
                <ActionParameter name="waitForAck">true</ActionParameter>
                <ActionParameter name="waitTime">1000</ActionParameter>
            </Action>
        </Action>
        <Action name="WaitForPubAcks" type="CheckPendingDeliveryTokens">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>


        <Action name="sync_4" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2-4</ActionParameter>
            <ActionParameter name="component_list">tx4;rx4;rx2-4;tx2-4</ActionParameter>
            <ActionParameter name="timeout">45000</ActionParameter>
        </Action>

        
<!-- Proxy drops MQTT Connections when A1 Server restarts, must reconnect, so close is not needed  -->        
        <Action name="CloseConnection1" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>


        <Action name="sync_5" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2-5</ActionParameter>
            <ActionParameter name="component_list">tx5;rx5;rx2-5;tx2-5</ActionParameter>
            <ActionParameter name="timeout">75000</ActionParameter>
        </Action>
        <Action name="sync_6" type="SyncComponentAction"> 
            <ActionParameter name="component_name">tx2-6</ActionParameter>
            <ActionParameter name="component_list">rx2-6;tx2-6</ActionParameter>
            <ActionParameter name="timeout">90000</ActionParameter>
        </Action>
        
        
        <Action name="CreateConnectionCleanUp" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">a:Org2:appType1</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="user">test05</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="CloseConnectionCleanUp" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

    </Action>



<!--  * * * * * *  Rx: d:Org2:deviceTypeX:deviceTX-66  * * * * * *   -->

    <Action name="d:Org2:deviceTypeX:deviceTX-66" type="CompositeAction">

        <Action name="CreateConnection0" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org2:deviceTypeX:deviceTX-66</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>
        <Action name="CloseConnection0" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
        
        <Action name="sync_0" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2-0</ActionParameter>
            <ActionParameter name="component_list">rx2-0;tx2-0</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

        <Action name="sync_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2-1</ActionParameter>
            <ActionParameter name="component_list">rx2-1;tx2-1</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>


<!-- Sleep Allows for RETAIN to be processed on Pub side so Subscribe will receive-->
        <Action name="WaitForRetainProcessingAtPub" type="Sleep">
            <ActionParameter name="waitTime">1000</ActionParameter>
        </Action>

	<Action name="CreateConnection1" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org2:deviceTypeX:deviceTX-66</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>

        <Action name="Subscribe_RETAIN1" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/cmd/RETAIN1/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
        </Action>
        <Action name="Subscribe_DuraTopic" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/cmd/DuraTopic/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
        </Action>
        <Action name="Subscribe_mon" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/mon</ApiParameter>
            <ApiParameter name="QoS">0</ApiParameter>
        </Action>
        <Action name="Subscribe_notify" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/notify</ApiParameter>
            <ApiParameter name="QoS">1</ApiParameter>
        </Action>

        <Action name="ReceiveMessage1" type="ReceiveMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">15000</ActionParameter>
        </Action>
        <Action name="CheckMessage1" type="CompareMessageData">
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="compareBody">Application CMD Message RETAIN1 in TEXT</ActionParameter>
            <ActionParameter name="compareTopic">iot-2/cmd/RETAIN1/fmt/txt</ActionParameter>
            <ActionParameter name="compareQoS">2</ActionParameter>
            <ActionParameter name="compareRetain">true</ActionParameter>
        </Action>
        <Action name="ReceiveNoMore1" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>

        <Action name="CloseConnection1" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

        <Action name="sync_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2-2</ActionParameter>
            <ActionParameter name="component_list">rx2-2;tx2-2</ActionParameter>
            <ActionParameter name="timeout">3000</ActionParameter>
        </Action>


	<Action name="CreateConnection2" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org2:deviceTypeX:deviceTX-66</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>

        
        <Action name="ReceiveMessages3-1" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="ReceiveMessage3-1" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <Action name="CheckMessage3-1" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="compareBody">{"Message":"Just some random JSON here for Message 3"}</ActionParameter>
                <ActionParameter name="compareTopic">iot-2/cmd/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
                <ActionParameter name="compareRetain">false</ActionParameter>
            </Action>
        </Action>
        
        <Action name="ReceiveNoMore3-1" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>
		
<!--  A1 restart will cause Proxy to drop MQTT Connections in sync4 -->
        <Action name="CloseConnection2-redo" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

     
        <Action name="sync_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2-3</ActionParameter>
            <ActionParameter name="component_list">rx2-3;tx2-3</ActionParameter>
            <ActionParameter name="timeout">15000</ActionParameter>
        </Action>

<!-- TX is queueing up 20 more msgs on Durable Subscription -->

        <Action name="sync_4" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2-4</ActionParameter>
            <ActionParameter name="component_list">tx4;rx4;rx2-4;tx2-4</ActionParameter>
            <ActionParameter name="timeout">45000</ActionParameter>
        </Action>
		
<!--  Note:  a:Org1 is restarting A1 here, Proxy will drop MQTT Connections -->

        <Action name="sync_5" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2-5</ActionParameter>
            <ActionParameter name="component_list">tx5;rx5;rx2-5;tx2-5</ActionParameter>
            <ActionParameter name="timeout">75000</ActionParameter>
        </Action>

               
<!-- Proxy drops MQTT Connections when A1 Server restarts, must reconnect  -->

	<Action name="CreateConnection2_redo" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org2:deviceTypeX:deviceTX-66</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">false</ApiParameter>
        </Action>

        <Action name="ReceiveMessages3-2" type="CompositeAction" repeat="20" repeat_interval="0">
            <Action name="ReceiveMessage3-2" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">30000</ActionParameter>
            </Action>
            <Action name="CheckMessage3-2" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="compareBody">{"Message":"Just some random JSON here for Message 3"}</ActionParameter>
                <ActionParameter name="compareTopic">iot-2/cmd/DuraTopic/fmt/json</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
                <ActionParameter name="compareRetain">false</ActionParameter>
            </Action>
        </Action>

        <Action name="ReceiveNoMore3-2" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>


        <Action name="Subscribe_RETAIN2" type="Subscribe">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ApiParameter name="topic">iot-2/cmd/RETAIN2/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
        </Action>
        <Action name="ReceiveMessage2" type="ReceiveMessage">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>
        <Action name="CheckMessage2" type="CompareMessageData">
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="compareBody">{"Message":"Application CMD Message RETAIN2 in JSON"}</ActionParameter>
            <ActionParameter name="compareTopic">iot-2/cmd/RETAIN2/fmt/json</ActionParameter>
            <ActionParameter name="compareQoS">2</ActionParameter>
            <ActionParameter name="compareRetain">true</ActionParameter>
        </Action>

        <Action name="ReceiveNoMore2" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">3000</ActionParameter>
        </Action>
		
        
        <Action name="sync_6" type="SyncComponentAction"> 
            <ActionParameter name="component_name">rx2-6</ActionParameter>
            <ActionParameter name="component_list">rx2-6;tx2-6</ActionParameter>
            <ActionParameter name="timeout">90000</ActionParameter>
        </Action>

        
        <Action name="CloseConnection2" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>

        <!-- Clear out the durable subscription -->
        <Action name="CreateConnectionCleanup" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>../common/PROXY_server.xml</include>
            <ApiParameter name="clientId">d:Org2:deviceTypeX:deviceTX-66</ApiParameter>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="user">test01</ApiParameter>
            <ApiParameter name="password">password</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="CloseConnectionCleanup" type="CloseConnection">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
    </Action>

</IsmWSTest>
                
