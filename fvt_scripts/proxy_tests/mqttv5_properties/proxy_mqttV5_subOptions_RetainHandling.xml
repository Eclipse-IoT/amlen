<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
 * Copyright (c) 2018-2021 Contributors to the Eclipse Foundation
 * 
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 * 
 * SPDX-License-Identifier: EPL-2.0
 */
-->
<IsmWSTest name="proxy_mqttV5_subOptions_RetainHandling" >
<!--
    Test MQTTv5 Spec 3.8.3.1 Subscription Options [BIT 4, 5]: RetainHandling
      0 = Send retained messages at the time of the subscribe
      1 = Send retained messages at subscribe only if the subscription does not currently exist
      2 = Do not send retained messages at the time of the subscribe

    Publish Retained and Not Retain msgs before subscribes
    Subscribes explicit and with wildcards  and with Retain Handling options
    
 -->  
    <SyncClient>
        <server>
            <include>../common/JMS_syncip.xml</include>
            <include>../common/JMS_syncport.xml</include>
        </server>
        <solution>proxy_mqttV5_subOptions_RetainHandling</solution>
    </SyncClient>
 
<!--  ==========  Publisher ==========  -->

    <Action name="RetainHandling_Pub" type="CompositeAction">
        <Action name="CreateConnectionV5" type="CreateConnection" >
            <ActionParameter name="structure_id">ConV5</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="connectionType">PAHO-MQTTv5</ActionParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="clientId">d:org4iot2:subOptsRetainHandling:Pub</ApiParameter>  
            <ApiParameter name="user">d:org4iot2:subOptsRetainHandling:Pub</ApiParameter>  
            <ApiParameter name="password">password</ApiParameter>  
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>
<!-- remove?  TopicTree did not like custom msg
        <Action name="CreateMessageNotRetain" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg1</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="msgType">TEXT</ApiParameter>
            <ApiParameter name="payload">Msg 1:{ clientId=d:org4iot2:subOptsRetainHandling:Pub, RETAIN:false, topic:iot-2/evt/subOptsRetainHandling/fmt/* }</ApiParameter>
            <ActionParameter name="RETAIN">false</ActionParameter>
        </Action>
        
        <Action name="CreateMessageRetain" type="CreateMessage">
            <ActionParameter name="structure_id">txmsg2</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="msgType">TEXT</ApiParameter>
            <ApiParameter name="payload">Msg 2:{ clientId=d:org4iot2:subOptsRetainHandling:Pub, RETAIN:true, topic:iot-2/evt/subOptsRetainHandling/fmt/* }</ApiParameter>
            <ActionParameter name="RETAIN">true</ActionParameter>
        </Action>
 -->
        <Action name="PublishTreeBeforeNotRetain" type="PublishTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
            <ActionParameter name="retained">false</ActionParameter>
            <ActionParameter name="clearRetained">false</ActionParameter>
        </Action>
        <Action name="PublishTreeBeforeRetain" type="PublishTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
            <ActionParameter name="retained">true</ActionParameter>
            <ActionParameter name="clearRetained">false</ActionParameter>
        </Action>

        <Action name="sync_UP_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">p1</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_1;subRH0_1;subRH1_1;subRH2_1;p1</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>

        
        <Action name="sync_UP_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">p2</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_2;subRH0_2;subRH1_2;subRH2_2;p2</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>
        
        <Action name="PublishTreeAfterNotRetain" type="PublishTopicTree">
          <dependsOn action_id="sync_UP_2" interval="1000" />
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
            <ActionParameter name="retained">false</ActionParameter>
            <ActionParameter name="clearRetained">false</ActionParameter>
        </Action>

        
        <Action name="sync_UP_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">p3</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_3;subRH0_3;subRH1_3;subRH2_3;p3</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>
         
        <Action name="PublishTreeAfterRetain" type="PublishTopicTree">
          <dependsOn action_id="sync_UP_3" interval="2000" />
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
            <ActionParameter name="retained">true</ActionParameter>
            <ActionParameter name="clearRetained">false</ActionParameter>
        </Action>


        <Action name="CloseConnectionV5" type="CloseConnection">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
        </Action>    
    </Action>
    

<!--  ==========  subscriber RetainHandling:0 ==========  -->

    <Action name="recvRH0" type="CompositeAction">
        <Action name="CreateConnectionV5" type="CreateConnection" >
            <ActionParameter name="structure_id">ConV5</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="connectionType">PAHO-MQTTv5</ActionParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="clientId">a:org4iot2:subOptsRetainHandling:SubRH0</ApiParameter>  
            <ApiParameter name="user">a:org4iot2:subOptsRetainHandling:SubRH0</ApiParameter>  
            <ApiParameter name="password">password</ApiParameter>  
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="sync_UP_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH0_1</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_1;subRH0_1;subRH1_1;subRH2_1;p1</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>
 <!-- Defect 207662 SubTree causes SubId error -->
        <Action name="SubscribeTreeRetainPublish" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
<!-- SubOpts RH 0x00 passed with QoS 0x00:            <ActionParameter name="RetainHandling">0</ActionParameter> -->
        </Action>
        
        
        <Action name="CompositeRcvOfBeforeSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareMsgsOfBeforeSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfBeforeSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        <!-- RE SUBSCRIBE -->
        <Action name="RE_SubscribeTreeRH0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
<!-- SubOpts RH 0x00 passed with QoS 0x00:            <ActionParameter name="RetainHandling">0</ActionParameter> -->
        </Action>
        
        <Action name="CompositeRcvAfterReSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareMsgsAfterReSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="NoRcvAfterReSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>
        

        <!-- Unsubscribe/ RENEW SUBSCRIBE -->
        <Action name="UN_SubscribeTreeRH0" type="UnsubscribeTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
        </Action>
        <Action name="RENEW_SubscribeTreeRH0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
<!-- SubOpts RH 0x00 passed with QoS 0x01:            <ActionParameter name="RetainHandling">0</ActionParameter> -->
        </Action>
        
        <Action name="CompositeRcvAfterUnSub-ReSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareMsgsAfterUnSub-ReSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="NoRcvAfterUnSub-ReSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>        
        
        
        <Action name="CHANGEQoS_SubscribeTreeRH0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
<!-- SubOpts passed in QoS            <ActionParameter name="RetainHandling">0</ActionParameter> -->
        </Action>

        
        
        <Action name="sync_UP_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH0_2</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_2;subRH0_2;subRH1_2;subRH2_2;p2</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>


        <Action name="CompositeRcvRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="CompositeRcvNOTRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareNOTRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">false</ActionParameter>
                <ActionParameter name="compareQoS">2</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfRetainAfterSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>


        <Action name="CHANGERetainAsPub_SubscribeTreeRH0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="prefix">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">10</ActionParameter>
            <ActionParameter name="qos">9</ActionParameter>
<!-- SubOpts passed in QoS:  RH 0x00 + RetainAsPub 0x08 + QoS 0x01
            <ActionParameter name="retainAsPublished">true</ActionParameter>
            <ActionParameter name="RetainHandling">0</ActionParameter>
-->
        </Action>

        
        <Action name="sync_UP_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH0_3</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_3;subRH0_3;subRH1_3;subRH2_3;p3</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>

        
        <Action name="CompositeRcvOLDRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">5000</ActionParameter>
            </Action>
            
            <Action name="CompareOLDRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>

        
        <Action name="CompositeRcvNEWRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareNEWRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfNEWRetainAfterSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        
        <Action name="CloseConnectionV5" type="CloseConnection">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
        </Action>    
    </Action>
     

<!--  ========== subscriber RetainHandling:1 ==========  -->

    <Action name="recvRH1" type="CompositeAction">
        <Action name="CreateConnectionV5" type="CreateConnection" >
            <ActionParameter name="structure_id">ConV5</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="connectionType">PAHO-MQTTv5</ActionParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="clientId">a:org4iot2:subOptsRetainHandling:SubRH1</ApiParameter>  
            <ApiParameter name="user">a:org4iot2:subOptsRetainHandling:SubRH1</ApiParameter>  
            <ApiParameter name="password">password</ApiParameter>  
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="sync_UP_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH1_1</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_1;subRH0_1;subRH1_1;subRH2_1;p1</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>
 
        <Action name="SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">18</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">2</ApiParameter>
<!-- SubOpts passed with QoS:  RH 0x10 + QoS 0x02            <ActionParameter name="RetainHandling">1</ActionParameter>  -->
        </Action>

        
        <Action name="CompositeRcvOfBeforeSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareMsgsOfBeforeSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfBeforeSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>
 
        <!-- RE SUBSCRIBE -->
        <Action name="RE_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">18</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">2</ApiParameter>
<!-- SubOpts passed with QoS:  RH 0x10 + QoS 0x02                        <ActionParameter name="RetainHandling">1</ActionParameter> -->
        </Action>
<!-- Defect 211510 - Retain were sent anyway -->    
        
        <Action name="NoRcvAfterReSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>
        

        <!-- Unsubscribe/ RENEW SUBSCRIBE -->
        <Action name="UN_SubscribeWC" type="Unsubscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
        </Action>
        
        <Action name="RENEW_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">18</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">2</ApiParameter>
<!-- SubOpts RH 0x10 passed with QoS 0x02:            <ActionParameter name="RetainHandling">1</ActionParameter> -->
        </Action>

        
        <Action name="CompositeRcvAfterUnSub-ReSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessagesAfterUnSub-ReSub" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareMsgsAfterUnSub-ReSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvAfterUnSub-ReSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>
 
        

        <!-- Change QoS ReSub -->
        <Action name="CHANGEQoS_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">17</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
<!-- SubOpts passed with QoS:  RH 0x10 + QoS 0x01            <ActionParameter name="RetainHandling">1</ActionParameter> -->
        </Action>

        
        <Action name="sync_UP_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH1_2</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_2;subRH0_2;subRH1_2;subRH2_2;p2</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>

        
        <Action name="CompositeRcvRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">0</ActionParameter>
            </Action>
        
        </Action>

        
        <Action name="CompositeRcvNOTRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareNOTRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">false</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfRetainAfterSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>


        <!-- Change RetainAsPub -->
        <Action name="CHANGERetainAsPub_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">25</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
<!-- SubOpts passed with QoS:  RH: 0x10 + RetainAsPublish 0x08 + QoS 0x01
            <ActionParameter name="RetainHandling">1</ActionParameter>
            <ActionParameter name="retainAsPublished">true</ActionParameter> -->
        </Action>

        
        <Action name="sync_UP_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH1_3</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_3;subRH0_3;subRH1_3;subRH2_3;p3</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>

<!-- Defect 211600 - Sub not recognized as changed UPDATED:   ONLY QoS will make new Subscription (which is MQTT Spec 'non-conformance' BTW )
     revised to accept NO OLD Retained msgs : SEE NOTES in defect  -->
        <Action name="ReceiveNO_OLDRetainAfterSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">750</ActionParameter>
        </Action>

        
        <Action name="CompositeRcvNEWRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessageNEWRetainAfterSub" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">5000</ActionParameter>
            </Action>
            
            <Action name="CompareNEWRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfNEWRetainAfterSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        
        <Action name="CloseConnectionV5" type="CloseConnection">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
        </Action>    
    </Action>
     
    

<!--  ==========  subscriber RetainHandling:2 ==========  -->

    <Action name="recvRH2" type="CompositeAction">
        <Action name="CreateConnectionV5" type="CreateConnection" >
            <ActionParameter name="structure_id">ConV5</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="connectionType">PAHO-MQTTv5</ActionParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="clientId">a:org4iot2:subOptsRetainHandling:SubRH2</ApiParameter>  
            <ApiParameter name="user">a:org4iot2:subOptsRetainHandling:SubRH2</ApiParameter>  
            <ApiParameter name="password">password</ApiParameter>  
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>


        <Action name="sync_UP_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH2_1</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_1;subRH0_1;subRH1_1;subRH2_1;p1</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>
        
<!-- SubOpts passed with QoS:  RetainHandling 0x20 + QoS 0x01=0x21 aka(33)             <ActionParameter name="RetainHandling">2</ActionParameter>    -->        
        <Action name="SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">33</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
        </Action>

        
<!-- RETAIN msgs are not delivered at SUB TIME when RH=0x20  -->        


        <Action name="FinalRcvOfRetainBeforeSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>
 
        <!-- RE SUBSCRIBE -->
<!-- SubOpts passed with QoS:  RetainHandling 0x20 + QoS 0x01            <ActionParameter name="RetainHandling">2</ActionParameter> -->
        <Action name="RE_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">33</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
        </Action>

<!-- Defect 211510 - Retain were sent anyway -->        
<!-- RETAIN msgs are not delivered at SUB TIME when RH=0x20  -->        


        <Action name="NoRcvAfterReSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>
        

        <!-- Unsubscribe/ RENEW SUBSCRIBE -->
        <Action name="UN_SubscribeWC" type="Unsubscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
        </Action>
        
<!-- SubOpts passed with QoS:  RetainHandling 0x20 + Q0S 0x02            <ActionParameter name="RetainHandling">2</ActionParameter> -->
        <Action name="RENEW_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">34</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">2</ApiParameter>
        </Action>

        
<!-- RETAIN msgs are not delivered at SUB TIME when RH=0x20  -->        


        <Action name="NoRcvAfterUnSub-ReSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        
        <!-- Change QoS ReSub -->
<!-- SubOpts passed with QoS: RetainHandling 0x20 + QoS 0x01            <ActionParameter name="RetainHandling">2</ActionParameter> -->
        <Action name="CHANGEQoS_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">33</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
        </Action> 
        
        
        <Action name="sync_UP_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH2_2</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_2;subRH0_2;subRH1_2;subRH2_2;p2</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>

        
<!-- RETAIN msgs are not delivered at SUB TIME when RH=0x20  -->        


        <Action name="CompositeRcvNOTRetainAfterChgSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareNOTRetainAfterChgSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">false</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
            </Action>
        
        </Action>

        <Action name="FinalRcvOfNOTRetainAfterChgSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>


        <!-- Change RetainAsPub -->
<!-- SubOpts Passed with QoS:  RetainHandling 0x20 + RetainAsPub 0x08  + QoS 1 = 32 + 8 + 1
            <ActionParameter name="RetainHandling">1</ActionParameter>
            <ActionParameter name="retainAsPublished">true</ActionParameter>
-->
        <Action name="CHANGERetainAsPub_SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">41</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
        </Action>

        
        <Action name="sync_UP_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">subRH2_3</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_3;subRH0_3;subRH1_3;subRH2_3;p3</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>

        
<!-- RH=2 no Retain delivered at SUB TIME, will recvieve msg with RETAIN Flagged, but these are Active, not RETAINed messages -->   
     
        <Action name="CompositeRcvNEWRetainAfterSubRAP" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">5000</ActionParameter>
            </Action>
            
            <Action name="CompareNEWRetainAfterSubRAP" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
            </Action>
        
        </Action>

        <Action name="FinalRcvOfNEWRetainAfterSubRAP" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        
        <Action name="CloseConnectionV5" type="CloseConnection">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
        </Action>    
    </Action>
     
         

<!--  ========== shared subscriber RetainHandling: 0 ==========  -->

    <Action name="sharedSub0" type="CompositeAction">
        <Action name="CreateConnectionV5" type="CreateConnection" >
            <ActionParameter name="structure_id">ConV5</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="connectionType">PAHO-MQTTv5</ActionParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="clientId">A:org4iot2:subOptsRetainHandling:SharedSub0</ApiParameter>  
            <ApiParameter name="user">A:org4iot2:subOptsRetainHandling:SharedSub0</ApiParameter>  
            <ApiParameter name="password">password</ApiParameter>  
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <Action name="sync_UP_1" type="SyncComponentAction"> 
            <ActionParameter name="component_name">shrSubRH0_1</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_1;subRH0_1;subRH2_1;subRH1_1;p1</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>
 
<!-- SubOpts passed with QoS:  RetainHandling 0x00 + QoS 0x02             <ActionParameter name="RetainHandling">tbd</ActionParameter> -->
        <Action name="SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">2</ApiParameter>
        </Action>

        
<!-- RETAIN MSGs are not delivered to Shared Subscriptions  -->

        
        <Action name="NoRcvOfBeforeSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        <!-- RE SUBSCRIBE -->
<!-- SubOpts passed with QoS:  RetainHandling 0x10?? + QoS 0x02             <ActionParameter name="RetainHandling">tbd</ActionParameter> -->
        <Action name="RE-SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">2</ApiParameter>
        </Action>

        
<!-- RETAIN MSGs are not delivered to Shared Subscriptions  -->
        
        
        <Action name="NoRcvOfAfterRESub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        <!-- Unsubscribe/ RENEW SUBSCRIBE -->
        <Action name="UN_SubscribeShared" type="Unsubscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
        </Action>
<!-- SubOpts passed with QoS:  RetainHandling 0x00 + QoS 0x02             <ActionParameter name="RetainHandling">tbd</ActionParameter> -->
        <Action name="RENEW-SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">2</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">2</ApiParameter>
        </Action>

        
<!-- RETAIN MSGs are not delivered to Shared Subscriptions  -->
        

        <Action name="NoRcvOfAfterUNSub_RESub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>
        
        
        <!-- Change QoS ReSub -->
<!-- SubOpts passed with QoS:  RetainHandling 0x00 + QoS 0x01             <ActionParameter name="RetainHandling">tbd</ActionParameter> -->
        <Action name="CHANGEQoS-SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">1</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
        </Action>

        
        <Action name="sync_UP_2" type="SyncComponentAction"> 
            <ActionParameter name="component_name">shrSubRH0_2</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_2;subRH0_2;subRH2_2;subRH1_2;p2</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>

        
<!-- RETAIN MSGs are not delivered to Shared Subscriptions  -->

        
        <Action name="CompositeRcvNOTRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
            
            <Action name="CompareNOTRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
<!-- Defect 211699 - QoS was not updated, arrives QoS 2  -->
                <ActionParameter name="compareRetain">false</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfNOTRetainAfterSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>


        <!-- Change RetainAsPub  RAP 0x08 + QoS 0x01 -->
        <Action name="CHANGERAP-SubscribeWithWC" type="Subscribe">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ApiParameter name="topic">iot-2/type/subOptsRetainHandling/id/Pub/evt/subOptsRetainHandling/fmt/+</ApiParameter>
            <ApiParameter name="QoS">9</ApiParameter>
            <ActionParameter name="waitForAck">true</ActionParameter>
            <ApiParameter name="expectedrc">1</ApiParameter>
        </Action>


        <Action name="sync_UP_3" type="SyncComponentAction"> 
            <ActionParameter name="component_name">shrSubRH0_3</ActionParameter>
            <ActionParameter name="component_list">shrSubRH0_3;subRH0_3;subRH2_3;subRH1_3;p3</ActionParameter>
            <ActionParameter name="timeout">20000</ActionParameter>
        </Action>


        
        <Action name="CompositeRcvNEWRetainAfterSub" type="CompositeAction" repeat="10">
            <Action name="ReceiveMessages" type="ReceiveMessage">
                <ActionParameter name="connection_id">CFV5</ActionParameter>
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="waitTime">5000</ActionParameter>
            </Action>
            
            <Action name="CompareNEWRetainAfterSub" type="CompareMessageData">
                <ActionParameter name="structure_id">rxmsg1</ActionParameter>
                <ActionParameter name="mqttMessageVersion">5</ActionParameter>
<!--                <ActionParameter name="compareBody">Msg 1:{ clientId=d:org4iot2:subOptsRetainHandling:Pub, RETAIN:false, topic:iot-2/evt/subOptsRetainHandling/fmt/* }</ActionParameter>  -->
                <ActionParameter name="compareRetain">true</ActionParameter>
                <ActionParameter name="compareQoS">1</ActionParameter>
            </Action>
        
        </Action>
        
        <Action name="FinalRcvOfNEWRetainAfterSub" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="structure_id">rxmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        
        <Action name="CloseConnectionV5" type="CloseConnection">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
        </Action>    
    </Action>


<!--  ========== shared subscriber RetainHandling: 1 ==========  -->

    <Action name="sharedSub1" type="CompositeAction">
        <Action name="CreateConnectionV5" type="CreateConnection" >
            <ActionParameter name="structure_id">ConV5</ActionParameter>
            <ActionParameter name="connection_id">CFV5</ActionParameter>
            <ActionParameter name="connectionType">PAHO-MQTTv5</ActionParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include>
            <ApiParameter name="clientId">A:org4iot2:subOptsRetainHandling:SharedSub1</ApiParameter>  
            <ApiParameter name="user">A:org4iot2:subOptsRetainHandling:SharedSub1</ApiParameter>  
            <ApiParameter name="password">password</ApiParameter>  
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        
        <!-- tbd -->
        
        <Action name="CloseConnectionV5" type="CloseConnection">
            <ActionParameter name="connection_id">CFV5</ActionParameter>
        </Action>    
    </Action>
  
</IsmWSTest>
                
