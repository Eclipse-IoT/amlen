<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
 * Copyright (c) 2013-2021 Contributors to the Eclipse Foundation
 * 
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 * 
 * SPDX-License-Identifier: EPL-2.0
 */
-->
<!--
    This test will subscribing to various MQTTv5 SharedSubscriptions with various error conditions. 
    
    For MQTTv5 Shared Subscriptions, the topic filter on the subscribe has three parts:
    
    It must start with $share to cue ISM that this is a shared subscription.
    
    The next element is the Subscription Name. 
    
    Then follows the Topic filter to subscriber to.
    
    Example: 
    
    $SharedSubcription/MySubscriptionName/RiverLevels/RedRiver
    
    This test uses the DemoEndpoint, which gives Control authorization for Subscription Messaging
    policies to to all clients. 
    
-->
<IsmWSTest name="testproxy_sharedMix_error01" >
    <!-- make sure the client we are about to use has no prior state --> 
    <!-- Create a clean - durable session Connection -->
    <Action name="CreateConnection" type="CreateConnection">
        <ActionParameter name="structure_id">Con1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionTypeV5.xml</include>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include>
        <ApiParameter name="clientId">sharedMix_error01</ApiParameter>

        <ApiParameter name="protocol">mqtt</ApiParameter>
        <ApiParameter name="cleanSession">true</ApiParameter>
        <ApiParameter name="sessionExpire">60</ApiParameter>
        <!-- ApiParameter name="verbose">true</ApiParameter-->
    </Action>    
    
    <!-- **************************************************** -->
    <!-- Section 1: This checks various illegal topic filters --> 
    <!-- **************************************************** -->
    
    <!-- invalid Topic filter. There must be a SubscriptionName and Topic --> 
    <Action name="Subscribe_NoSubName" type="Subscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share/</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>
    <Action name="CheckConnectionGoodNoSubName" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        
    
    <!-- invalid Topic filter. The SubscriptionName is an empty string and Topic is missing-->
    <Action name="Subscribe_NoSubName2" type="Subscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share//</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>    
    <Action name="CheckConnectionGoodNoSubName2" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        
    
    <!-- invalid Topic filter. The SubscriptionName is an empty string-->
    <Action name="Subscribe_NoSubName3" type="Subscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share//SomeTopic</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>    
    <Action name="CheckConnectionGoodNoSubName3" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>    
        
    <!-- There is a Subname.. but topic filter is missing --> 
    <Action name="Subscribe_NoTopicName1" type="Subscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share/ErrorSub01</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>
    <Action name="CheckConnectionGoodNoTopicName1" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>   
    
    <!-- **************************************************** -->
    <!-- Section 2: This checks various illegal topic filters
             on unsubcribes --> 
    <!-- **************************************************** -->
    <Action name="UnSubscribe_NoSubName" type="Unsubscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share/</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>
    <Action name="CheckConnectionGoodNoUnSubName" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        

    <Action name="UnSubscribe_NoSubName2" type="Unsubscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share//</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>    
    <Action name="CheckConnectionGoodNoUnSubName2" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        

    <Action name="UnSubscribe_NoSubName3" type="Unsubscribe">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share//SomeTopic</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>    
    <Action name="CheckConnectionGoodNoUnSubName3" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>    

    <Action name="UnSubscribe_NoTopicName2" type="Unsubscribe">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share/ErrorSub01/</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>    
    <Action name="CheckConnectionGoodNoUnSubTopicName2" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        
    
    <!-- **************************************************** -->
    <!-- Section 3: This checks various illegal topic filters
         on publish --> 
    <!-- **************************************************** -->
    <Action name="CreateRandomMessage" type="CreateRandomMessage">
        <ActionParameter name="structure_id">txmsg1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="length">190</ActionParameter>
        <ApiParameter name="QoS">1</ApiParameter>
    </Action>
    
    <!-- the publish should fail 143, and stay connected. --> 
    <Action name="SendMessage_InvalidSharedSub" type="SendMessage">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="message_id">txmsg1</ActionParameter>
        <ActionParameter name="topic">$share/SubName/TopicName</ActionParameter>
    </Action>
    
    <Action name="CheckConnection8FAIL" type="CheckConnection" >
        <dependsOn action_id="SendMessage_InvalidSharedSub" interval="1000"/>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
		<ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>  

    <Action name="CreateRandomMessage2" type="CreateRandomMessage">
        <ActionParameter name="structure_id">txmsg1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="length">190</ActionParameter>
        <ApiParameter name="QoS">1</ApiParameter>
    </Action>
    
    <Action name="SendMessage_InvalidSharedSub2" type="SendMessage">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="message_id">txmsg1</ActionParameter>
        <ActionParameter name="topic">$share/SubNameConn9</ActionParameter>
    </Action>    

    <Action name="CheckConnection9FAIL" type="CheckConnection" >
        <dependsOn action_id="SendMessage_InvalidSharedSub2" interval="500"/>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
		<ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>    
    
    <Action name="CreateRandomMessage3" type="CreateRandomMessage">
        <ActionParameter name="structure_id">txmsg1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="length">190</ActionParameter>
        <ApiParameter name="QoS">1</ApiParameter>
    </Action>

    <Action name="SendMessage_InvalidSharedSub3a" type="SendMessage">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="message_id">txmsg1</ActionParameter>
        <ActionParameter name="topic">$share/</ActionParameter>
    </Action>    

    <Action name="CheckConnection10FAIL" type="CheckConnection" >
        <dependsOn action_id="SendMessage_InvalidSharedSub3a" interval="500"/>
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
		<ApiParameter name="expectedrcv5">143</ApiParameter>
    </Action>   
         
    <Action name="CloseConnection" type="CloseConnection" > 
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>
    
    <!-- **************************************************** -->
    <!-- Section 4: This checks a bit of GVT in topic filters --> 
    <!-- **************************************************** -->

    <!-- Recreating the session without a cleanSession=True results
    in immediately being disconnected when it retries the publish.
    So this cleans it for the next test. --> 
    <Action name="ReCreateConnectionGVTClear" type="CreateConnection">
        <ActionParameter name="structure_id">Con1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionTypeV5.xml</include>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include> 
        <ApiParameter name="clientId">sharedMix_error01</ApiParameter>

        <ApiParameter name="protocol">mqtt</ApiParameter>
        <ApiParameter name="path">config.ism.ibm.com</ApiParameter>
        <ApiParameter name="cleanSession">true</ApiParameter>
        <!-- ApiParameter name="verbose">true</ApiParameter-->
    </Action>
    
    <Action name="CreateConnectionGVTClearClose" type="CloseConnection">
           <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>     
    
    <!-- Now show that we can create a valid consumer. And add a little GVT as well. -->
       <Action name="ReCreateConnectionGVT1" type="CreateConnection">
        <ActionParameter name="structure_id">Con1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionTypeV5.xml</include>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include> 
        <ApiParameter name="clientId">sharedMix_error01</ApiParameter>

        <ApiParameter name="protocol">mqtt</ApiParameter>
        <ApiParameter name="path">config.ism.ibm.com</ApiParameter>
        <ApiParameter name="cleanSession">false</ApiParameter>
        <ApiParameter name="sessionExpire">60</ApiParameter>
        <!-- ApiParameter name="verbose">true</ApiParameter-->
    </Action>
    
    <Action name="CheckConnectionGVT1Good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>   
        
    <!-- Valid subscription and topic names --> 
    <Action name="Subscribe_GVTopicName2" type="Subscribe">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share/葛渚噓/GVTDurTopic02/葛渚噓</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
        <ApiParameter name="expectedrcv5">1</ApiParameter>
    </Action>

    <Action name="restStatCallGVT" type="RestAPI">
        <ActionParameter name="structureID">stat_output_GVT</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/葛渚噓/GVTDurTopic02/葛渚噓&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareRESTGVT" type="CompareREST">
        <ActionParameter name="structureID">stat_output_GVT</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/葛渚噓/GVTDurTopic02/葛渚噓</ActionParameter>
        <ObjectProperty name="BufferedMsgs" value="0"/>
        <ObjectProperty name="PublishedMsgs" value="0"/>
    </Action>        
    
    <!-- Valid unsubscribe --> 
    <Action name="UnSubscribe_GVTopicName2" type="Unsubscribe">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share/葛渚噓/GVTDurTopic02/葛渚噓</ApiParameter>
        <ApiParameter name="QoS">1</ApiParameter>
    </Action>     
    
    <Action name="CheckConnectionGVT" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>   
    
    <Action name="restStatCallGVT_Gone" type="RestAPI">
        <ActionParameter name="structureID">stat_output_GVTGone</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/葛渚噓/GVTDurTopic02/葛渚噓&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareRESTGVT_Gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_GVTGone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/葛渚噓/GVTDurTopic02/葛渚噓</ActionParameter>
    </Action>        
    
    <Action name="CloseConnectionGVT" type="CloseConnection">
        <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>  
    
    <!-- **************************************************** -->
    <!-- Section 5: This checks various illegal topic filters 
        when subscribing to multiple topics--> 
    <!-- **************************************************** -->
    
    
       <Action name="ReCreateConnection11" type="CreateConnection">
        <ActionParameter name="structure_id">Con1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionTypeV5.xml</include>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include> 
        <ApiParameter name="clientId">sharedMix_error01</ApiParameter>

        <ApiParameter name="protocol">mqtt</ApiParameter>
        <ApiParameter name="path">config.ism.ibm.com</ApiParameter>
        <ApiParameter name="cleanSession">false</ApiParameter>
        <ApiParameter name="sessionExpire">60</ApiParameter>
        <!-- ApiParameter name="verbose">true</ApiParameter-->
    </Action>
    
    <Action name="CheckConnection11Good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        
    
    <!-- invalid Topic filter. The SubscriptionName is an empty string-->
    <Action name="Subscribe_NoSubName11_Middle" type="Subscribe">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topics">/validTopic:$share//SomeSpecialTopic:/AnotherValidTopic</ApiParameter>
        <ApiParameter name="QoSlist">0:0:0</ApiParameter>
        <ApiParameter name="expectedrcv5">0:143:0</ApiParameter>
    </Action>    
    <Action name="CheckConnection12Good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        
    
    <!-- invalid Topic filter. The SubscriptionName and Topic name are missing on the end -->
    <Action name="Subscribe_NoSubName12_End" type="Subscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topics">/validTopic:/AnotherValidTopic/Subtopic:$share/</ApiParameter>
        <ApiParameter name="QoSlist">0:0:0</ApiParameter>
        <ApiParameter name="expectedrcv5">0:0:143</ApiParameter>
    </Action>    
    <Action name="CheckConnection13Good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        
    
    <!-- invalid Topic filter. The SubscriptionName is an empty string in the first topic-->
    <Action name="Subscribe_NoSubName13_Start" type="Subscribe" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topics">$share/sharedMix_error01Subname:/validTopic:/AnotherValidTopic</ApiParameter>
        <ApiParameter name="QoSlist">0:0:0</ApiParameter>
        <ApiParameter name="expectedrcv5">143:0:0</ApiParameter>
    </Action>    

    <Action name="CheckConnection14Good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>        
    
    <!-- **************************************************** -->
    <!-- Section 6:  validates unsubscribes.. reconnecting a 
        client, and that cleansession=true cleans up
        DurableSubscriptions These are not strictly error 
        cases.--> 
    <!-- **************************************************** -->
   
    
    <!-- Valid and Multiple Durable Shared and Durable Non Shared Subs Topic filters. -->
    <Action name="Subscribe_MultValidShared" type="Subscribe">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topics">$share/sharedMix_error01Subname/Valid:/validTopic:/AnotherValidTopic:$share/sharedMix_error01Subname2//Valid2</ApiParameter>
        <ApiParameter name="QoSlist">0:1:2:2</ApiParameter>
        <ApiParameter name="expectedrcv5">0:1:2:2</ApiParameter> 
    </Action>    

    <Action name="CheckConnection14Still_good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>    
    
   <Action name="restShowsharedMix_error01Subname" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="Valid"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>                                            
    
    <Action name="restShowsharedMix_error01Subname2" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname2" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="/Valid2"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>                                                    
    
    <Action name="restShowNonSharedSubs" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/validTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>    
    
    <Action name="compareShowNonSharedSubs2" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/AnotherValidTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>        
    
    <Action name="CloseConnectionWithDurableSubscriptions" type="CloseConnection">
           <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>   
    
    <!-- Now show the subscriptions again. They should exist, but have
        no consumers. (this is checked in comparelogs looking for 
        the  subscriptions with consumers=0 ) --> 

   <Action name="restShowsharedMix_error01Subname_NoCons" type="RestAPI">
           <dependsOn action_id="CloseConnectionWithDurableSubscriptions" interval="1000"/>
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="Valid"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>                                            

    <Action name="restShowsharedMix_error01Subname2_NoCons" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname2_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="/Valid2"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>        
                    
    <Action name="restShowNonSharedSubs_NoCons" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/validTopic"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>    
    
    <Action name="compareShowNonSharedSubs2_NoCons" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/AnotherValidTopic"/>
        <ObjectProperty name="Consumers" value="0"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>             
    
    <!-- Clean session is false.. so our subscriptions should be there, and 
        I think show consumers. --> 
       <Action name="ReCreateConnection15Good" type="CreateConnection">
        <ActionParameter name="structure_id">Con1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionTypeV5.xml</include>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include> 
        <ApiParameter name="clientId">sharedMix_error01</ApiParameter>

        <ApiParameter name="protocol">mqtt</ApiParameter>
        <ApiParameter name="path">config.ism.ibm.com</ApiParameter>
        <ApiParameter name="cleanSession">false</ApiParameter>
        <ApiParameter name="sessionExpire">60</ApiParameter>
        <!-- ApiParameter name="verbose">true</ApiParameter-->
    </Action>
    
    <Action name="CheckConnection15Good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>    
    
    <!-- we don't need to resubscribe. --> 
   <Action name="restShowsharedMix_error01Subname_again" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="Valid"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>            

   <Action name="restShowsharedMix_error01Subname2_again" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowsharedMix_error01Subname2_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
        <ObjectProperty name="IsShared" value="true"/>
        <ObjectProperty name="TopicString" value="/Valid2"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>            
    
    <Action name="restShowNonSharedSubs_again" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/validTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>    
    
    <Action name="compareShowNonSharedSubs2_again" type="CompareREST">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
        <ObjectProperty name="IsShared" value="false"/>
        <ObjectProperty name="TopicString" value="/AnotherValidTopic"/>
        <ObjectProperty name="Consumers" value="1"/>
        <ObjectProperty name="IsDurable" value="true"/>
    </Action>            
    
    <!-- try both ways of getting rid of a Durable Shared Subscription in MQTT
        Method 1 is be the last one to unsubscribe (if you you have Control authority
        which we do). -->
    <Action name="UnSubscribe_Shared1" type="Unsubscribe">
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ApiParameter name="topic">$share/sharedMix_error01Subname/Valid</ApiParameter>
    </Action>
    
   <Action name="restShowsharedMix_error01Subname_gone" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname/Valid&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>        
    
    <Action name="compareShowsharedMix_error01Subname_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname/Valid</ActionParameter>
    </Action>        
                 
    <!-- Method 2 is to close, and reconnect with clean session. (again, you need 
        control authority -->         
    <Action name="CloseConnectionWithDurableSubscription" type="CloseConnection">
           <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>    
    
    <!-- reopen, with cleansession=true, should delete all subscriptions --> 
       <Action name="ReCreateConnection16Good" type="CreateConnection">
        <ActionParameter name="structure_id">Con1</ActionParameter>
        <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionTypeV5.xml</include>
            <include>../common/PROXY_server.xml</include>
            <include>../common/PROXY_port.xml</include> 
        <ApiParameter name="clientId">sharedMix_error01</ApiParameter>

        <ApiParameter name="protocol">mqtt</ApiParameter>
        <ApiParameter name="path">config.ism.ibm.com</ApiParameter>
        <ApiParameter name="cleanSession">true</ApiParameter>
        <!-- ApiParameter name="verbose">true</ApiParameter-->
    </Action>
    
    <Action name="CheckConnection16Good" type="CheckConnection" >
        <ActionParameter name="connection_id">CF1</ActionParameter>
        <ActionParameter name="isConnected">true</ActionParameter>
    </Action>    

    <!-- These should have been removed on cleansession. --> 

    <Action name="restShowsharedMix_error01Subname2_gone" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?SubName=/sharedMix_error01Subname2//Valid2&amp;ClientID=__SharedM</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>        
    
    <Action name="compareShowsharedMix_error01Subname2_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/sharedMix_error01Subname2//Valid2</ActionParameter>
    </Action>            
    
    <Action name="restShowNonSharedSubs_gone" type="RestAPI">
        <ActionParameter name="structureID">stat_output_1_again</ActionParameter>
        <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        <ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=sharedMix_error01</ActionParameter>
        <ActionParameter name="action">GET</ActionParameter>
        <ActionParameter name="payload"></ActionParameter>
        <ActionParameter name="printResult">true</ActionParameter>
        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
        <ActionParameter name="expectedMessageCode"></ActionParameter>
    </Action>

    <Action name="compareShowNonSharedSubs1_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/validTopic</ActionParameter>
    </Action>    
    
    <Action name="compareShowNonSharedSubs2_gone" type="CompareREST" rc="1" reason="ISMTEST3416">
        <ActionParameter name="structureID">stat_output_1_gone</ActionParameter>
        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
        <ActionParameter name="subObjectKey">SubName</ActionParameter>
        <ActionParameter name="subObjectName">/AnotherValidTopic</ActionParameter>
    </Action>                
    
    <Action name="Finalclose" type="CloseConnection">
           <ActionParameter name="connection_id">CF1</ActionParameter>
    </Action>   
        
</IsmWSTest>
                