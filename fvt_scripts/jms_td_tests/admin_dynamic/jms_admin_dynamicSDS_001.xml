<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
 * Copyright (c) 2013-2021 Contributors to the Eclipse Foundation
 * 
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 * 
 * SPDX-License-Identifier: EPL-2.0
 */

  TestCase Name: jms_admin_dynamicSDS_001

  Test Category:  JMS Dynamic Policy Updates
  
  
  Test Description:
  
  Logon using different messaging policies. Make sure the global shared durable shared subscription
  gets a messaging policy assigned when it is created, and that the messaging Policy 
  is NOT changed when a subscriber uses a different TopicPolicy or a different Subscription Policy.
  
  For GlobalShared Durable Subscriptions, the policy assocated to the subscription 
  should be the original DestinationType=Subscription used when the subscription
  was originally created, and never changed.  
  
  This test changes the endpoint to reorder/remove various policies as the subscriber connects/disconnects. 
  
  It also verifies that when JMS 'changes' a subscription (such as adding a selector to 
  the subsription) ,  that it is treated as a delete/recreate, and two things happen: 
  
  		The 'new' subscription has the Subscription Messaging Policy from the client that made the change.  
  		That if the old SubscriptionPolicy was in Pending Delete state, it gets deleted at that time. 
  
  And Then it verifies that deleting a subscription from a command line will cause a pending delete Messaging Policy 
  to get deleted.  

-->    

<ImaJmsTest name="jms_admin_dynamicDS_001.xml">

	<SyncClient>
	<server>
	    <include>../common/JMS_syncip.xml</include>
		<include>../common/JMS_syncport.xml</include>
	</server>
	<solution>jms_admin_dynamicSDS_002</solution>
    </SyncClient>

	<Action name="cons1" type="CompositeAction">

		<!-- A connection factor without a clientID -->
		<Action name="Create_cf1" type="CreateConnectionFactory">
			<ActionParameter name="structure_id">cf1</ActionParameter>
			<!--ActionParameter name="loglevel">9</ActionParameter>
			<ActionParameter name="logfile">stdout</ActionParameter-->
		</Action>
		<Action name="SetProps_cf1" type="FillIsmProps">
			<ActionParameter name="structure_id">cf1</ActionParameter>
			<ActionParameter name="validateAll">true</ActionParameter>
			<ActionParameter name="validateNoWarn">false</ActionParameter>
			<include>../common/JMS_server.xml</include>
			<ImaProperty name="Port" value="20027"/>
		</Action>

		<Action name="sync_components_cons1a" type="SyncComponentAction"> 
		    <ActionParameter name="component_name">cons1a</ActionParameter>
		    <ActionParameter name="component_list">prod1a;cons1a</ActionParameter>
		    <ActionParameter name="timeout">15000</ActionParameter>
		</Action>	
	
		<!-- Successfully connect without a clientID(cf1) -->
		<Action name="CreateConnection_cf1" type="CreateConnection">
			<ActionParameter name="structure_id">connection_cf1</ActionParameter>
		 	<ActionParameter name="factory_id">cf1</ActionParameter>
		</Action>		
				
		<!-- Create a session --> 
		<Action name="CreateSession1_conn_cf1" type="CreateSession">
			<ActionParameter name="conn_id">connection_cf1</ActionParameter>
		 	<ActionParameter name="structure_id">session1_cf1</ActionParameter>
		</Action>	
		
		<!-- Create a Destination to used to create a  subscription  -->
		<Action name="CreateDestination_cons1" type="CreateDestination">
			<ApiParameter name="name">/DynamicFredHasATopic</ApiParameter>
			<ActionParameter name="type">topic</ActionParameter>
			<ActionParameter name="structure_id">FredsTopic</ActionParameter>
		</Action>                                                                                                             
		
		<!-- create Global Shared Durable Subscription --> 
		<Action name="CreateConsumerFred_1" type="CreateSharedDurableConsumer">
			<ActionParameter name="structure_id">consumer1_Fred</ActionParameter>
			<ActionParameter name="dest_id">FredsTopic</ActionParameter>
			<ActionParameter name="session_id">session1_cf1</ActionParameter>
			<ApiParameter name="durableName">DurableFred_has_a_Subscription</ApiParameter>
		</Action>
			
		<!-- Better be using DynamicMPSubscription1 on the subscription just now. --> 
		<Action name="ShowSubExists_WithMPS1" type="RestAPI">
	        <ActionParameter name="structureID">subexists_mps1</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareShowSubExists_WithMPS1" type="CompareREST">
        	<ActionParameter name="structureID">subexists_mps1</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription1"/>
        	<ObjectProperty name="MaxMessages" value="1000"/>
	    </Action>

		<Action name="Update_SP1" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration</ActionParameter>
	        <ActionParameter name="action">POST</ActionParameter>
    	    <ActionParameter name="payload">{"SubscriptionPolicy":{"DynamicMPSubscription1":{"Protocol":"MQTT","MaxMessages":1111}}}</ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>
		
		<!-- Better be using DynamicMP1 on the subscription just now. --> 
		<Action name="ShowSubExists_WithMPS1_MM1111" type="RestAPI">
	        <ActionParameter name="structureID">subexists_mm1111</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareShowSubExists_WithMPS1_MM1111" type="CompareREST">
        	<ActionParameter name="structureID">subexists_mm1111</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription1"/>
        	<ObjectProperty name="MaxMessages" value="1111"/>
	    </Action>

		<!-- remove DynamicMPSubscription1,2,3 from the Endpoint.  --> 
		<Action name="RemoveMP1_from_Endpoint" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration</ActionParameter>
	        <ActionParameter name="action">POST</ActionParameter>
    	    <ActionParameter name="payload">{"Endpoint":{"DynamicEP2":{"TopicPolicies":"DynamicMP2,DynamicMP3,DynamicMP4,DynamicMP5","SubscriptionPolicies":"DynamicMPSubscription2,DynamicMPSubscription3,DynamicMPSubscription5"}}}</ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

		<!-- I'm updating a MP that isn't on an endpoint. .  --> 
		<Action name="Update_RemovedSP1_from_Endpoint" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration</ActionParameter>
	        <ActionParameter name="action">POST</ActionParameter>
    	    <ActionParameter name="payload">{"SubscriptionPolicy":{"DynamicMPSubscription1":{"Protocol":"MQTT","MaxMessages":111122}}}</ActionParameter>
    	    <ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>
		
		<!-- Better still be using DynamicMPSubscription3 on the subscription just now. COMPAREREST needs to check the MaxMessages. -->
		<Action name="WhatHappened_to_MaxMessages" type="RestAPI">
	        <ActionParameter name="structureID">whathappened_mm</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareWhatHappened_to_MaxMessages" type="CompareREST">
        	<ActionParameter name="structureID">whathappened_mm</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription1"/>
        	<ObjectProperty name="MaxMessages" value="111122"/>
	    </Action> 
		
<!-- DELETE SubscriptionPolicy that isn't on an endpoint, but is on a Subscription.  It should go pending in v1.2, NOW it is Successfully DELETED  --> 
		<Action name="Delete_RemovedSP1_from_Endpoint" type="RestAPI">
	        <ActionParameter name="structureID">Del_mm</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">DELETE</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>	
		
<!-- This would be in the state of "PendingDelete" in v1.2, in Angel it is DELETED.  --> 
		<Action name="WhatHappened_to_SP1" type="RestAPI">
	        <ActionParameter name="structureID">whathappened_mm</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">404</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

<!-- This Fails: Expected result is: SUCCESS. Real result was javax.jms.JMSException: Top level object does not exist - SubscriptionPolicy
[29/09/15 05:44:53:232 GMT] 000010 E RMTD2100: Action CompareWhatHappened_to_SP1 failed. The reason is: Result of the ISM API is not as expected.
java.lang.RuntimeException: Result of the ISM API is not as expected.
java.lang.RuntimeException: Result of the ISM API is not as expected.
	at com.ibm.ima.jms.test.ApiCallAction.checkExpectedResult(ApiCallAction.java:59)
	at com.ibm.ima.jms.test.ApiCallAction.run(ApiCallAction.java:108)
	at com.ibm.ima.jms.test.Action.execute(Action.java:255)
	at com.ibm.ima.jms.test.CompositeAction$CompositeActionRunable.run(CompositeAction.java:200)
	at com.ibm.ima.jms.test.CompositeAction.run(CompositeAction.java:89)
	at com.ibm.ima.jms.test.Action.execute(Action.java:255)
	at com.ibm.ima.jms.test.JMSTestDriver$RMTestRunnable.run(JMSTestDriver.java:120)
	at java.lang.Thread.run(Thread.java:777)
Caused by: javax.jms.JMSException: Top level object does not exist - SubscriptionPolicy
	at com.ibm.ima.jms.test.CompareRESTAction.invokeApi(CompareRESTAction.java:165)
	at com.ibm.ima.jms.test.ApiCallAction.run(ApiCallAction.java:103)
	... 6 more
[29/09/15 05:44:53:233 GMT] 000010 I RMTD5002: Action CompareRESTAction:CompareWhatHappened_to_SP1 failed.
- - - - -
    	<Action name="CompareWhatHappened_to_SP1" type="CompareREST">
        	<ActionParameter name="structureID">whathappened_mm</ActionParameter>
	        <ActionParameter name="topLevelKey">SubscriptionPolicy</ActionParameter>
        	<ActionParameter name="subObjectName">DynamicMPSubscription1</ActionParameter>
        	<ObjectProperty name="PendingAction" value="Delete"/>
	    </Action> 
-->		
<!-- Better still be using DynamicMPSubscription1 on the subscription just now. --> 
 		<Action name="ShowSubExists_WithWhat_SP" type="RestAPI">
	        <ActionParameter name="structureID">subexists_withwhat</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareShowSubExists_WithWhat_SP" type="CompareREST">
        	<ActionParameter name="structureID">subexists_withwhat</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription1"/>
        	<ObjectProperty name="MaxMessages" value="111122"/>
	    </Action> 
		
<!-- In v1.2 updating a MP that is in pending delete state, In Angel have to recreate.  The Policy change is applied to the subscription.  --> 
		<Action name="Update_SP1_when_in_pending_delete_state" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration</ActionParameter>
	        <ActionParameter name="action">POST</ActionParameter>
    	    <ActionParameter name="payload">{"SubscriptionPolicy":{"DynamicMPSubscription1":{"Protocol":"MQTT","MaxMessages":111133,  "Subscription":"DurableFred_has_a_Subscription","ActionList":"Control,Receive"}}}</ActionParameter>
    	    <ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

 		<!-- Better still be using DynamicMPSubscription1 on the subscription just now. --> 
 		<Action name="ShowSubExists_With_SP1_updatedWhilePendingDelete" type="RestAPI">
	        <ActionParameter name="structureID">subexists_whilepending</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareShowSubExists_With_SP1_updatedWhilePendingDelete" type="CompareREST">
        	<ActionParameter name="structureID">subexists_whilepending</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription1"/>
        	<ObjectProperty name="MaxMessages" value="111133"/>
	    </Action>   

		<!-- close all active consumers on all subscriptions. --> 
		<Action name="CloseConsumerFred_1" type="CloseConsumer">
			<ActionParameter name="consumer_id">consumer1_Fred</ActionParameter>
		</Action>

		<!-- Should connect with a different Subscription Policy, (the original is not on the 
		Endpoint any more. But this SHOULD NOT UPDATE the subscription!  --> 
		<Action name="CreateConsumerFred_2" type="CreateSharedDurableConsumer">
			<ActionParameter name="structure_id">consumer1_Fred</ActionParameter>
			<ActionParameter name="dest_id">FredsTopic</ActionParameter>
			<ActionParameter name="session_id">session1_cf1</ActionParameter>
			<ApiParameter name="durableName">DurableFred_has_a_Subscription</ApiParameter>
		</Action>
		
		<Action name="CloseConsumerFred_2" type="CloseConsumer">
			<ActionParameter name="consumer_id">consumer1_Fred</ActionParameter>
		</Action>
		
		<!-- Better be using DynamicMPSubscription1 on the subscription just now. --> 
		<Action name="ShowSubExists_withPendingDeleted_Policy" type="RestAPI">
	        <ActionParameter name="structureID">subexists_whilependingInactive</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareShowSubExists_withPendingDeleted_Policy" type="CompareREST">
        	<ActionParameter name="structureID">subexists_whilependingInactive</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription1"/>
        	<ObjectProperty name="MaxMessages" value="111133"/>
	    </Action>  
	    
<!-- The Subscription Policy should still exist (in pending delete)  since its still in use by the DurableSubscription -->
		<Action name="Make_sure_SubPolicy_NotGone_1" type="RestAPI">
	        <ActionParameter name="structureID">subnotgone1</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareMake_sure_SubPolicy_NotGone_1" type="CompareREST">
        	<ActionParameter name="structureID">subnotgone1</ActionParameter>
	        <ActionParameter name="topLevelKey">SubscriptionPolicy</ActionParameter>
        	<ActionParameter name="subObjectName">DynamicMPSubscription1</ActionParameter>
        	<!-- ObjectProperty name="PendingAction" value="Delete"/  NOT IN ANGEL -->
        	<ObjectProperty name="Protocol" value="MQTT"/>
        	<ObjectProperty name="MaxMessages" value="111133"/>
	    </Action>						

		<!-- this should cause a delete/recreate of the subscription.. and two things should happen. 
			First: the new subscription will use a DynamicMPSubscription3.  
			Second: DynamicMPSubscription1 will be deleted since it use count just went to zero. --> 
		<Action name="CreateConsumerFred_3_withSelector" type="CreateSharedDurableConsumer">
			<ActionParameter name="structure_id">consumer1_Fred</ActionParameter>
			<ActionParameter name="dest_id">FredsTopic</ActionParameter>
			<ActionParameter name="session_id">session1_cf1</ActionParameter>
			<ApiParameter name="selector">TestProperty = 'sender 1'</ApiParameter>
			<ApiParameter name="durableName">DurableFred_has_a_Subscription</ApiParameter>
		</Action>

		<!-- Use count reached zero. This should finally be gone. -->
		<Action name="Make_sure_SubPolicy_IsNOTGone" type="RestAPI">
	        <ActionParameter name="structureID">policynotgone</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>
		
		<Action name="MakesureSubGone_1" type="RestAPI">
	        <ActionParameter name="structureID">subgone1</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">-1</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareMakesureSubGone_1" type="CompareREST" rc="1" reason="ISMTEST3416">
        	<ActionParameter name="structureID">subgone1</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
	    </Action> 		

		<Action name="MakesureNewSub_usesNewPolicy" type="RestAPI">
	        <ActionParameter name="structureID">subnewpolicy</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription3</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareMakesureNewSub_usesNewPolicy" type="CompareREST">
        	<ActionParameter name="structureID">subnewpolicy</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription3"/>
        	<ObjectProperty name="MaxMessages" value="3000"/>
	    </Action> 

		<Action name="CloseConnection_cf1" type="CloseConnection">
			<ActionParameter name="conn_id">connection_cf1</ActionParameter>
		</Action>
		

		<!-- A  new connection on a new endpoint -->
		<Action name="Create_cf2" type="CreateConnectionFactory">
			<ActionParameter name="structure_id">cf2</ActionParameter>
			<!--ActionParameter name="loglevel">9</ActionParameter>
			<ActionParameter name="logfile">stdout</ActionParameter-->
		</Action>
		<Action name="SetProps_cf2" type="FillIsmProps">
			<ActionParameter name="structure_id">cf2</ActionParameter>
			<ActionParameter name="validateAll">true</ActionParameter>
			<ActionParameter name="validateNoWarn">false</ActionParameter>
			<include>../common/JMS_server.xml</include>
			<ImaProperty name="Port" value="20028"/>
		</Action>
	
		<!-- Successfully connect without a clientID(cf2) -->
		<Action name="CreateConnection_cf2" type="CreateConnection">
			<ActionParameter name="structure_id">connection_cf2</ActionParameter>
		 	<ActionParameter name="factory_id">cf2</ActionParameter>
		</Action>		
				
		<!-- Create a session --> 
		<Action name="CreateSession1_conn_cf2" type="CreateSession">
			<ActionParameter name="conn_id">connection_cf2</ActionParameter>
		 	<ActionParameter name="structure_id">session1_cf2</ActionParameter>
		</Action>	
		
		<!-- Create a Destination to used to create a  subscription  -->
		<Action name="CreateDestination_cons2" type="CreateDestination">
			<ApiParameter name="name">/DynamicFredHasATopic</ApiParameter>
			<ActionParameter name="type">topic</ActionParameter>
			<ActionParameter name="structure_id">FredsTopic2</ActionParameter>
		</Action>                                                                                                             
		
		<!-- Subscribe with same name, but change selector. This should cause a delete/recreate 
		for the subscription, and that should get it a new SubscriptionPolicy.  Global Shared Durable Subscription --> 
		<Action name="CreateConsumerFred_cf2" type="CreateSharedDurableConsumer">
			<ActionParameter name="structure_id">consumer2_Fred</ActionParameter>
			<ActionParameter name="dest_id">FredsTopic2</ActionParameter>
			<ActionParameter name="session_id">session1_cf2</ActionParameter>
			<ApiParameter name="selector">TestProperty = 'sender s'</ApiParameter>
			<ApiParameter name="durableName">DurableFred_has_a_Subscription</ApiParameter>
		</Action>
			
		<!-- Better be using DynamicMPSubscription5 on the subscription just now. --> 
		<Action name="ShowSubExists_WithMPS5" type="RestAPI">
	        <ActionParameter name="structureID">subnewpolicy5</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/monitor/Subscription?ClientID=__Shared&amp;MessagingPolicy=DynamicMPSubscription5</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

    	<Action name="CompareShowSubExists_WithMPS5" type="CompareREST">
        	<ActionParameter name="structureID">subnewpolicy5</ActionParameter>
	        <ActionParameter name="topLevelKey">Subscription</ActionParameter>
    	    <ActionParameter name="subObjectKey">SubName</ActionParameter>
        	<ActionParameter name="subObjectName">DurableFred_has_a_Subscription</ActionParameter>
        	<ObjectProperty name="MessagingPolicy" value="DynamicMPSubscription5"/>
        	<ObjectProperty name="MaxMessages" value="5000"/>
	    </Action> 			
							
		<!-- remove DynamicMPSubscription5 the Endpoints.  --> 
		<Action name="RemoveSP5_from_EndpointEP1" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration</ActionParameter>
	        <ActionParameter name="action">POST</ActionParameter>
    	    <ActionParameter name="payload">{"Endpoint":{"DynamicEP1":{"TopicPolicies":"DynamicMP2,DynamicMP3,DynamicMP4,DynamicMP5","SubscriptionPolicies":"DynamicMPSubscription2,DynamicMPSubscription3"}}}</ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>
		
		<Action name="RemoveSP5_from_EndpointEP2" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration</ActionParameter>
	        <ActionParameter name="action">POST</ActionParameter>
    	    <ActionParameter name="payload">{"Endpoint":{"DynamicEP2":{"TopicPolicies":"DynamicMP2,DynamicMP3,DynamicMP4,DynamicMP5","SubscriptionPolicies":"DynamicMPSubscription2,DynamicMPSubscription3"}}}</ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>	

		<Action name="RemoveSP5_from_EndpointEP3" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration</ActionParameter>
	        <ActionParameter name="action">POST</ActionParameter>
    	    <ActionParameter name="payload">{"Endpoint":{"DynamicEP3":{"TopicPolicies":"DynamicMP2,DynamicMP3,DynamicMP4,DynamicMP5","SubscriptionPolicies":"DynamicMPSubscription2,DynamicMPSubscription3"}}}</ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

		<Action name="Delete_DynamicMPSubscription5" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription5</ActionParameter>
	        <ActionParameter name="action">DELETE</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>	
			
<!-- This would be in the state of "PendingDelete" in v1.2, in Angel it is DELETED.  --> 
	<Action name="Show_PendingDelete_DynamicMPSubscription5" type="RestAPI">
	    <ActionParameter name="structureID">pendingdelete5</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
       	    <ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription5</ActionParameter>
	    <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
	    <ActionParameter name="expectedStatusCode">404</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>

<!-- JCD  There is no Subscription to SHOW cause there is no PENDING DELETE
    	<Action name="CompareShow_PendingDelete_DynamicMPSubscription5" type="CompareREST">
        	<ActionParameter name="structureID">pendingdelete5</ActionParameter>
	        <ActionParameter name="topLevelKey">SubscriptionPolicy</ActionParameter>
        	<ActionParameter name="subObjectName">DynamicMPSubscription5</ActionParameter>
        	<ObjectProperty name="PendingAction" value="Delete"/>
	    </Action>					
-->
		<!-- close all active consumers on all subscriptions. --> 
		<Action name="CloseConsumerFred_3" type="CloseConsumer">
			<ActionParameter name="consumer_id">consumer2_Fred</ActionParameter>
		</Action>
		
		<Action name="CloseSession1_cf1" type="CloseSession">
			<ActionParameter name="session_id">session1_cf2</ActionParameter>
		</Action>		
		
		<Action name="Delete_Subscription_ViaCLI" type="RestAPI">
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/service/Subscription/__Shared/DurableFred_has_a_Subscription</ActionParameter>
	        <ActionParameter name="action">DELETE</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>
		
		<!-- the subscription was deleted. .The MP should now have usecount=0, and be deleted --> 
		<Action name="Show_DynamicMPSubscription5_isGone" type="RestAPI">
			<dependsOn name="Delete_Subscription_ViaCLI" interval="1000"/>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription5</ActionParameter>
	        <ActionParameter name="action">GET</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">404</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>
				
		<Action name="CloseSession1_cf2" type="CloseSession">
			<ActionParameter name="session_id">session1_cf2</ActionParameter>
		</Action>		
		
		<Action name="CloseConnection_cf2" type="CloseConnection">
			<ActionParameter name="conn_id">connection_cf2</ActionParameter>
		</Action>
		
		<!--  signal test is done and producer can finish. --> 
    	<Action name="Sync_DS_Done" type="SyncAction">
            <ActionParameter name="request">set</ActionParameter>
            <ActionParameter name="condition">Cons_DS_Done</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
        </Action>			

	</Action>		

 <Action name="prod1" type="CompositeAction">
    
	<Action name="Createprod_cf1" type="CreateConnectionFactory">
	    <ActionParameter name="structure_id">prod1_cf1</ActionParameter>
	    <ActionParameter name="loglevel">9</ActionParameter>
	    <ActionParameter name="logfile">stdout</ActionParameter>
	</Action>

	<Action name="CreateListener_prod" type="CreateExceptionListener">
		<ActionParameter name="structure_id">listener1</ActionParameter>
	</Action>

	<Action name="SetFactoryProps_prod" type="FillIsmProps">
		<ActionParameter name="structure_id">prod1_cf1</ActionParameter>
	   <ActionParameter name="validateAll">true</ActionParameter>
	    <ActionParameter name="validateNoWarn">false</ActionParameter>
	    <ImaProperty name="ClientID" value="DynamicFredsProducer" type="STRING"/>
	    <include>../common/JMS_server.xml</include>
	    <ImaProperty name="Port" value="16102" type="STRING"/>
		</Action>
        
	<Action name="CreateConnectionprod1_cf1" type="CreateConnection">
	    <ActionParameter name="structure_id">connection_prod1_cf1</ActionParameter>
	    <ActionParameter name="factory_id">prod1_cf1</ActionParameter>
		<ApiParameter name="exceptionListener">listener1</ApiParameter>
	</Action>
        
	<Action name="CreateSession1prod1_conn_cf1" type="CreateSession">
	    <ActionParameter name="conn_id">connection_prod1_cf1</ActionParameter>
	    <ActionParameter name="structure_id">session1_prod1_cf1</ActionParameter>
	</Action>

	<Action name="Createprod1_dest1" type="CreateDestination">
	    <ActionParameter name="structure_id">prod1_dest1</ActionParameter>
	    <ApiParameter name="name">/DynamicFredHasATopic</ApiParameter>
	    <ActionParameter name="type">topic</ActionParameter>
	</Action>

	<Action name="CreateProducer1prod1_dest1" type="CreateProducer">
	    <ActionParameter name="structure_id">producer1</ActionParameter>
	    <ActionParameter name="dest_id">prod1_dest1</ActionParameter>
	    <ActionParameter name="session_id">session1_prod1_cf1</ActionParameter>
	</Action>
        
	<Action name="StartConnectionprod1_cf1" type="StartConnection">
	    <ActionParameter name="conn_id">connection_prod1_cf1</ActionParameter>
	</Action>
        
	<!-- PRODUCER: Create messages -->
        
	<Action name="CreateTxtMessage_prod_dest1" type="CreateMessage">
	    <ActionParameter name="structure_id">prod1_txt_msg1</ActionParameter>
	    <ActionParameter name="session_id">session1_prod1_cf1</ActionParameter>
	    <ApiParameter name="msgType">TEXT</ApiParameter>
	</Action>	
        
	<!-- PRODUCER: Set message content -->                
	<Action name="WriteBytesMessage_prod_dest1" type="SetMessageText">
	    <ActionParameter name="message_id">prod1_txt_msg1</ActionParameter>
	    <ApiParameter name="value">TEXT: Message sent fromjms_admin_dynamicND_001.xml test.</ApiParameter>
	</Action>	
        
	<Action name="SetMessageProperty" type="SetMessageProperty">
	    <ActionParameter name="message_id">prod1_txt_msg1</ActionParameter>
	    <ApiParameter name="propertyName">ID</ApiParameter>
	    <ApiParameter name="propertyType">Common</ApiParameter>
	    <ApiParameter name="valueType">Integer</ApiParameter>
	    <ApiParameter name="value">1</ApiParameter>
	</Action>
        
	<Action name="StartConnection_cf1" type="StartConnection">
	    <ActionParameter name="conn_id">connection_prod1_cf1</ActionParameter>
	</Action>
        
	<!-- wait for the first consumer to create the subscription, and then publish some messages
		that will accumulate on the server. --> 
	<Action name="sync_components_prod1a" type="SyncComponentAction"> 
	    <ActionParameter name="component_name">prod1a</ActionParameter>
	    <ActionParameter name="component_list">prod1a;cons1a</ActionParameter>
	    <ActionParameter name="timeout">15000</ActionParameter>
	</Action>
	
	<Action name="SendBytesMessage_prod1a" type="SendMessage" repeat_interval="5" atleast="10"  repeat="5000" interval="0" thread="11">
		<dependsOn name="sync_components_prod1a" interval="0"/>
	    <ActionParameter name="producer_id">producer1</ActionParameter>
	    <ActionParameter name="message_id">prod1_txt_msg1</ActionParameter>
	    <ActionParameter name="incrID">1</ActionParameter>
	</Action>	
	
		<!-- wait for signal consumer is done.  --> 
    	<Action name="Sync_DS_Done" type="SyncAction">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">Cons_DS_Done</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">35000</ActionParameter>
        </Action>
				
	<Action name="Delete_SP1_forgood" type="RestAPI">
	        <ActionParameter name="structureID">Del_mm</ActionParameter>
    	    <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
        	<ActionParameter name="path">/ima/v1/configuration/SubscriptionPolicy/DynamicMPSubscription1</ActionParameter>
	        <ActionParameter name="action">DELETE</ActionParameter>
    	    <ActionParameter name="payload"></ActionParameter>
        	<ActionParameter name="printResult">true</ActionParameter>
	        <ActionParameter name="expectedStatusCode">200</ActionParameter>
    	    <ActionParameter name="expectedMessageCode"></ActionParameter>
    	</Action>	
		
		
	<!-- close the connection.. which will cause the send loop to finish. and end the test. --> 
	<Action name="CloseConnectionprod1_cf1" type="CloseConnection">
	    <ActionParameter name="conn_id">connection_prod1_cf1</ActionParameter>
	</Action>
  </Action>
	

</ImaJmsTest>
