<?xml version="1.0" encoding="UTF-8"?>
<!--
/*
 * Copyright (c) 2013-2021 Contributors to the Eclipse Foundation
 * 
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 * 
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 * 
 * SPDX-License-Identifier: EPL-2.0
 */
-->
<IsmWSTest name="testmqtt_clusterRM_001" >
<!--
    TODO: Fill in a brief description
-->
    <SyncClient>
        <server>
            <include>../common/JMS_syncip.xml</include>
            <include>../common/JMS_syncport.xml</include>
        </server>
        <solution>testmqtt_clusterRM_001</solution>
    </SyncClient>

    <!-- ********************************************************************************************* -->
    <!-- A1 publisher -->
    <!-- ********************************************************************************************* -->
    <Action name="A1Publish" type="CompositeAction">
        <!-- Get service status -->
        <Action name="restServiceStatusA1" type="RestAPI">
            <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Get cluster membership status -->
        <Action name="restClusterMembershipStatusA1" type="RestAPI">
            <ActionParameter name="server">``A1_HOST``:``A1_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/configuration/ClusterMembership</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Connect -->
        <Action name="CreateConnectionA1" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server1.xml</include>
            <ApiParameter name="clientId">RM_001_pub1</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Publish -->
        <Action name="PublishLoopA1" type="CompositeAction" repeat="1000000" repeat_interval="200" atleast="5">
            <Action name="PublishToManyA1-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">1</ActionParameter>
                <ActionParameter name="endIndex">30</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA1-q1" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA1-q0" interval="15"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">31</ActionParameter>
                <ActionParameter name="endIndex">45</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA1-q2" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA1-q1" interval="15"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">46</ActionParameter>
                <ActionParameter name="endIndex">50</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>
        </Action>
        <!-- *** -->
        <Action name="SyncReadyToCloseA1" type="SyncAction" thread="10">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A4_verified</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>


        <!-- Disconnect -->
        <Action name="CloseConnectionA1" type="CloseConnection" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
    </Action>

    <!-- ********************************************************************************************* -->
    <!-- A2 publisher -->
    <!-- ********************************************************************************************* -->
    <Action name="A2Publish" type="CompositeAction">
        <!-- Get service status -->
        <Action name="restServiceStatusA2" type="RestAPI">
            <ActionParameter name="server">``A2_HOST``:``A2_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Get cluster membership status -->
        <Action name="restClusterMembershipStatusA2" type="RestAPI">
            <ActionParameter name="server">``A2_HOST``:``A2_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/configuration/ClusterMembership</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Connect -->
        <Action name="CreateConnectionA2" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server2.xml</include>
            <ApiParameter name="clientId">RM_001_pub2</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Publish -->
        <Action name="PublishLoopA2" type="CompositeAction" repeat="1000000" repeat_interval="200" atleast="5">
            <Action name="PublishToManyA2-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">0</ActionParameter>
                <ActionParameter name="endIndex">30</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA2-q1" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA2-q0" interval="30"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">31</ActionParameter>
                <ActionParameter name="endIndex">45</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA2-q2" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA2-q1" interval="30"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">46</ActionParameter>
                <ActionParameter name="endIndex">50</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>
        </Action>

        <Action name="SyncReadyToCloseA2" type="SyncAction" thread="10">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A4_verified</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>

        <!-- Disconnect -->
        <Action name="CloseConnectionA2" type="CloseConnection" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
    </Action>



    <!-- ********************************************************************************************* -->
    <!-- A3 publisher -->
    <!-- ********************************************************************************************* -->
    <Action name="A3Publish" type="CompositeAction">
        <!-- Get service status -->
        <Action name="restServiceStatusA3" type="RestAPI">
            <ActionParameter name="server">``A3_HOST``:``A3_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Get cluster membership status -->
        <Action name="restClusterMembershipStatusA3" type="RestAPI">
            <ActionParameter name="server">``A3_HOST``:``A3_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/configuration/ClusterMembership</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Connect -->
        <Action name="CreateConnectionA3" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server3.xml</include>
            <ApiParameter name="clientId">RM_001_pub3</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Publish -->
        <Action name="PublishLoopA3" type="CompositeAction" repeat="1000000" repeat_interval="200" atleast="5">
            <Action name="PublishToManyA3-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">0</ActionParameter>
                <ActionParameter name="endIndex">30</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-q1" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA3-q0" interval="20"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">31</ActionParameter>
                <ActionParameter name="endIndex">45</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-q2" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA3-q1" interval="20"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">46</ActionParameter>
                <ActionParameter name="endIndex">50</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>
        </Action>

        <!-- A3 publish retained messages -->
        <Action name="PublishLoopA3-RM" type="CompositeAction" repeat="10" repeat_interval="200" atleast="1" thread="2">
            <dependsOn action_id="CreateConnectionA3" interval="1000"/>
	        <Action name="PublishToManyA3-RM-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">101</ActionParameter>
                <ActionParameter name="endIndex">130</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-RM-q1" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA3-RM-q0" interval="20"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">131</ActionParameter>
                <ActionParameter name="endIndex">145</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-RM-q2" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA3-RM-q1" interval="20"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">146</ActionParameter>
                <ActionParameter name="endIndex">150</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>
        </Action>

        <Action name="SyncRMsPubd" type="SyncAction" thread="2">
            <ActionParameter name="request">set</ActionParameter>
            <ActionParameter name="condition">RMsPubd</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
        </Action>

        <!-- Wait for A4 to go down, then send special retained messages -->
        <Action name="SyncWaitForA4Down" type="SyncAction" thread="2">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A4_Stopped</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>

        <!-- A3 publishes special retained messages -->
        <Action name="PublishLoopA3-newRM" type="CompositeAction" repeat="1" thread="2">
            <Action name="PublishToManyA3-newRM-null-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">101</ActionParameter>
                <ActionParameter name="endIndex">104</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">true</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-null-q1" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">105</ActionParameter>
                <ActionParameter name="endIndex">108</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">true</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-null-q2" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">109</ActionParameter>
                <ActionParameter name="endIndex">110</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">true</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-new-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">121</ActionParameter>
                <ActionParameter name="endIndex">130</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
                <ActionParameter name="messageAttach">NewMessage-q0</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-new-q1" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">131</ActionParameter>
                <ActionParameter name="endIndex">140</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
                <ActionParameter name="messageAttach">NewMessage-q1</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-new-q2" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">141</ActionParameter>
                <ActionParameter name="endIndex">150</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
                <ActionParameter name="messageAttach">NewMessage-q2</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-newtopics-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">151</ActionParameter>
                <ActionParameter name="endIndex">160</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
                <ActionParameter name="messageAttach">NewMessage-q0</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-newtopics-q1" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">161</ActionParameter>
                <ActionParameter name="endIndex">165</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
                <ActionParameter name="messageAttach">NewMessage-q1</ActionParameter>
            </Action>

            <Action name="PublishToManyA3-newRM-newtopics-q2" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">165</ActionParameter>
                <ActionParameter name="endIndex">170</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">true</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
                <ActionParameter name="messageAttach">NewMessage-q2</ActionParameter>
            </Action>
        </Action>

        <!-- Sync point after special RMs sent from A3 -->
        <Action name="SyncSpcRMsPubd" type="SyncAction" thread="2">
            <ActionParameter name="request">set</ActionParameter>
            <ActionParameter name="condition">A3_spcRMs_Sent</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
        </Action>

        <Action name="SyncReadyToCrashA3" type="SyncAction" thread="2">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A3_spcRMs_Sent</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>

        <!-- crash a3 non-gracefully (shell action) -->
        <Action name="KillA3" type="ShellAction" thread="2">
            <ActionParameter name="command">../scripts/cluster.py -a killClusterMember -m 3 -v 2 -f testmqtt_clusterRM_001.killA3.log</ActionParameter>
            <ActionParameter name="print_result">1</ActionParameter>
        </Action>

        <Action name="SyncA3killed" type="SyncAction" thread="2">
            <dependsOn action_id="KillA3" interval="5000"/>
            <ActionParameter name="request">set</ActionParameter>
            <ActionParameter name="condition">A3_killed</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
        </Action>


    </Action>

    <!-- ********************************************************************************************* -->
    <!-- A4 publisher -->
    <!-- ********************************************************************************************* -->
    <Action name="A4Publish" type="CompositeAction">
        <!-- Get service status -->
        <Action name="restServiceStatusA4" type="RestAPI">
            <ActionParameter name="server">``A4_HOST``:``A4_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Get cluster membership status -->
        <Action name="restClusterMembershipStatusA4" type="RestAPI">
            <ActionParameter name="server">``A4_HOST``:``A4_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/configuration/ClusterMembership</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Connect -->
        <Action name="CreateConnectionA4" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server4.xml</include>
            <ApiParameter name="clientId">RM_001_pub4</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Publish -->
        <Action name="PublishLoopA4" type="CompositeAction" repeat="1000000" repeat_interval="200" atleast="5">
            <Action name="PublishToManyA4-q0" type="PublishTopicTree">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">0</ActionParameter>
                <ActionParameter name="endIndex">30</ActionParameter>
                <ActionParameter name="qos">0</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA4-q1" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA4-q0" interval="25"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">31</ActionParameter>
                <ActionParameter name="endIndex">45</ActionParameter>
                <ActionParameter name="qos">1</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>

            <Action name="PublishToManyA4-q2" type="PublishTopicTree">
                <dependsOn action_id="PublishToManyA4-q1" interval="25"/>
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
                <ActionParameter name="startIndex">46</ActionParameter>
                <ActionParameter name="endIndex">50</ActionParameter>
                <ActionParameter name="qos">2</ActionParameter>
                <ActionParameter name="retained">false</ActionParameter>
                <ActionParameter name="clearRetained">false</ActionParameter>
            </Action>
        </Action>

        <!-- **** -->
        <Action name="SyncReadyToCloseA4" type="SyncAction" thread="10">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A4_verified</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>

    </Action>


    <Action name="A1Subscribe" type="CompositeAction">
        <!-- Connect -->
        <Action name="CreateConnectionA1S" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server1.xml</include>
            <ApiParameter name="clientId">RM_001_sub1</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Subscribe -->
        <Action name="SubscribeToManyA1-q0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">15</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA1-q1" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">31</ActionParameter>
            <ActionParameter name="endIndex">34</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA1-q2" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">46</ActionParameter>
            <ActionParameter name="endIndex">50</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <!-- Receive -->
        <Action name="ReceiveMessagesA1" type="CompositeAction" repeat="1000000" atleast="5">
            <Action name="ReceiveMessage" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">submsg1</ActionParameter>
                <ActionParameter name="waitTime">8000</ActionParameter>
            </Action>
        </Action>


        <!-- Wait for A4 Verified then disconnect -->
        <Action name="SyncReadyToCloseA1S" type="SyncAction" thread="10">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A4_verified</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>


        <!-- Disconnect -->
        <Action name="CloseConnectionA1S" type="CloseConnection" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
    </Action>

    <!-- ********************************************************************************************* -->
    <!-- A2 subscribe -->
    <!-- ********************************************************************************************* -->
    <Action name="A2Subscribe" type="CompositeAction">
        <!-- Connect -->
        <Action name="CreateConnectionA2S" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server2.xml</include>
            <ApiParameter name="clientId">RM_001_sub2</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Subscribe -->
        <Action name="SubscribeToManyA2-q0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">16</ActionParameter>
            <ActionParameter name="endIndex">30</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA2-q1" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">35</ActionParameter>
            <ActionParameter name="endIndex">38</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA2-q2" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">46</ActionParameter>
            <ActionParameter name="endIndex">50</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <!-- Receive -->
        <Action name="ReceiveMessagesA2" type="CompositeAction" repeat="1000000" atleast="5">
            <Action name="ReceiveMessage" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">submsg1</ActionParameter>
                <ActionParameter name="waitTime">6000</ActionParameter>
            </Action>
        </Action>

        <!-- After A3 killed, use admin remove api to remove from cluster -->
        <Action name="SyncWaitA3Killed-A2" type="SyncAction" thread="10">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A3_killed</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>

        <!-- Expect 2 disconnected servers -->
        <Action name="restServiceStatusA2S" type="RestAPI" thread="10">
            <ActionParameter name="structureID">status_output</ActionParameter>
            <ActionParameter name="server">``A2_HOST``:``A2_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <Action name="compareRESTservicestatusA2" type="CompareREST" thread="10">
            <ActionParameter name="structureID">status_output</ActionParameter>
            <ActionParameter name="topLevelKey">Cluster</ActionParameter>
            <ActionParameter name="topLevelType">JSONObject</ActionParameter>
            <ObjectProperty name="DisconnectedServers" value="2"/>
        </Action>

        <!-- Remove Inactive member API call -->

        <Action name="removeInactiveMember" type="ShellAction" thread="10">
            <dependsOn action_id="compareRESTservicestatusA2" interval="1000"/>
            <ActionParameter name="command">../scripts/cluster.py -a removeInactiveMember -m 2 -v 2 -f testmqtt_clusterRM_001.removeInactiveMember.log -m2r 3</ActionParameter>
            <ActionParameter name="print_result">1</ActionParameter>
        </Action>

        <!-- after remove there should be 1 disconnected server -->

        <Action name="restCheckDisconnectedServerCount" type="RestAPI" thread="10">
            <dependsOn action_id="removeInactiveMember" interval="1000"/>
            <ActionParameter name="structureID">status_output2</ActionParameter>
            <ActionParameter name="server">``A2_HOST``:``A2_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <Action name="checkDisconnectedServerCount" type="CompareREST" thread="10">
            <ActionParameter name="structureID">status_output2</ActionParameter>
            <ActionParameter name="topLevelKey">Cluster</ActionParameter>
            <ActionParameter name="topLevelType">JSONObject</ActionParameter>
            <ObjectProperty name="DisconnectedServers" value="1"/>
        </Action>

        <Action name="SyncA3Removed" type="SyncAction" thread="10">
            <dependsOn action_id="checkDisconnectedServerCount"/>
            <ActionParameter name="request">set</ActionParameter>
            <ActionParameter name="condition">A3RemovedFromCluster</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
        </Action>

        <!-- Check retained messages -->

        <Action name="UnsubscribeToMany-A2-0" type="UnsubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">16</ActionParameter>
            <ActionParameter name="endIndex">50</ActionParameter>
        </Action>

        <Action name="SubscribeToNewRMsA2-1" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">101</ActionParameter>
            <ActionParameter name="endIndex">104</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA2-2" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">105</ActionParameter>
            <ActionParameter name="endIndex">108</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA2-3" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">109</ActionParameter>
            <ActionParameter name="endIndex">110</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>
        <!-- Expect null -->
        <Action name="ReceiveNewRMs-A2-1" type="CompositeAction" repeat="10" repeat_interval="0" thread="10">
            <Action name="ReceiveNulls" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
        </Action>

        <Action name="UnsubscribeToMany-A2-1" type="UnsubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">101</ActionParameter>
            <ActionParameter name="endIndex">110</ActionParameter>
        </Action>

        <!-- Expect old messages -->
        <Action name="SubscribeToNewRMsA2-4" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">111</ActionParameter>
            <ActionParameter name="endIndex">120</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <!-- Receive -->
        <Action name="ReceiveRMsA2-1" type="CompositeAction" repeat="10" repeat_interval="0" thread="10">
            <Action name="ReceiveMessages-A2-RM-1" type="ReceiveMessage" >
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <!-- Old messages should start with "PublishToMany", new messages will start with NewMessage -->
            <Action name="CheckMessage-A2-1" type="CompareMessageData">
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="compareBodyStart">PublishToMany</ActionParameter>
            </Action>
        </Action>

        <Action name="UnsubscribeToMany-A2-2" type="UnsubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">101</ActionParameter>
            <ActionParameter name="endIndex">110</ActionParameter>
        </Action>

        <Action name="CheckNoMore-A2-1" type="ReceiveMessage" rc="1" reason="ISMTEST1143" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">newmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        <!-- Expect new messages -->
        <Action name="SubscribeToNewRMsA2-5" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">121</ActionParameter>
            <ActionParameter name="endIndex">130</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA2-6" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">131</ActionParameter>
            <ActionParameter name="endIndex">140</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA2-7" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">141</ActionParameter>
            <ActionParameter name="endIndex">150</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <Action name="ReceiveRMsA2-2" type="CompositeAction" repeat="30" repeat_interval="0" thread="10">
            <Action name="ReceiveMessages-A4-RM-2" type="ReceiveMessage" >
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <!-- Old messages should start with "PublishToMany", new messages will start with "NewMessage" -->
            <Action name="CheckMessage-A2-2" type="CompareMessageData">
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="compareBodyStart">NewMessage</ActionParameter>
            </Action>
        </Action>

        <Action name="CheckNoMore-A2-2" type="ReceiveMessage" rc="1" reason="ISMTEST1143" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">newmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        <Action name="UnsubscribeToMany-A2-3" type="UnsubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">111</ActionParameter>
            <ActionParameter name="endIndex">150</ActionParameter>
        </Action>


        <!-- Expect new messages (new topics) -->
        <Action name="SubscribeToNewRMsA2-8" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">151</ActionParameter>
            <ActionParameter name="endIndex">160</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA2-9" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">161</ActionParameter>
            <ActionParameter name="endIndex">165</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA2-10" type="SubscribeTopicTree" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">166</ActionParameter>
            <ActionParameter name="endIndex">170</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <Action name="ReceiveRMsA2-3" type="CompositeAction" repeat="20" repeat_interval="0" thread="10">
            <Action name="ReceiveMessages-A2-RM-3" type="ReceiveMessage" >
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <!-- Old messages should start with "PublishToMany", new messages will start with "NewMessage" -->
            <Action name="CheckMessage-A2-3" type="CompareMessageData">
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="compareBodyStart">NewMessage</ActionParameter>
            </Action>
        </Action>

        <Action name="CheckNoMore-A2-3" type="ReceiveMessage" rc="1" reason="ISMTEST1143" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">newmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>


        <!-- Wait for A4 Verified then disconnect -->
        <Action name="SyncReadyToCloseA2S" type="SyncAction" thread="10">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A4_verified</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>


        <!-- Disconnect -->
        <Action name="CloseConnectionA2S" type="CloseConnection" thread="10">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>
    </Action>

    <!-- ********************************************************************************************* -->
    <!-- A3 subscribe -->
    <!-- ********************************************************************************************* -->
    <Action name="A3Subscribe" type="CompositeAction">
        <!-- Connect -->
        <Action name="CreateConnectionA3S" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server3.xml</include>
            <ApiParameter name="clientId">RM_001_sub3</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>


        <!-- Subscribe -->
        <Action name="SubscribeToManyA3-q0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">1</ActionParameter>
            <ActionParameter name="endIndex">20</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA3-q1" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">39</ActionParameter>
            <ActionParameter name="endIndex">42</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA3-q2" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">46</ActionParameter>
            <ActionParameter name="endIndex">50</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <!-- Receive -->
        <Action name="ReceiveMessagesA3" type="CompositeAction" repeat="1000000" atleast="5">
            <Action name="ReceiveMessage" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">submsg1</ActionParameter>
                <ActionParameter name="waitTime">5000</ActionParameter>
            </Action>
        </Action>


        <!-- No close connection action here because server crashed anyway-->
    </Action>


    <!-- ********************************************************************************************* -->
    <!-- Subscriber A4 -->
    <!-- ********************************************************************************************* -->
    <Action name="A4Subscribe" type="CompositeAction" thread="10">
        <Action name="restServiceStatusA4" type="RestAPI">
            <ActionParameter name="server">``A4_HOST``:``A4_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- Get cluster membership status -->
        <Action name="restClusterMembershipStatusA4" type="RestAPI" thread="10">
            <ActionParameter name="server">``A4_HOST``:``A4_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/configuration/ClusterMembership</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <Action name="CreateConnectionA4S" type="CreateConnection">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server4.xml</include>
            <ApiParameter name="clientId">RM_001_sub4</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Subscribe -->
        <Action name="SubscribeToManyA4-q0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">10</ActionParameter>
            <ActionParameter name="endIndex">20</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA4-q1" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">43</ActionParameter>
            <ActionParameter name="endIndex">45</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA4-q2" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">46</ActionParameter>
            <ActionParameter name="endIndex">50</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <!-- Subscribe to Retained Messages topics -->
        <Action name="SubscribeToManyA4-RM-q0" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">100</ActionParameter>
            <ActionParameter name="endIndex">130</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA4-RM-q1" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">131</ActionParameter>
            <ActionParameter name="endIndex">145</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToManyA4-RM-q2" type="SubscribeTopicTree">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">146</ActionParameter>
            <ActionParameter name="endIndex">150</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <!-- verify messages being received then take down A4 -->
         <Action name="StatCluster_onA4" type="RestAPI" thread="2" >
            <dependsOn action_id="SubscribeToManyA4-q0" interval="15000" />
            <ActionParameter name="structureID">stat_Cluster_A4</ActionParameter>
            <ActionParameter name="server">``A4_IPv4_1``:``A4_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/v1/monitor/Cluster</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="payload"></ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
            <ActionParameter name="expectedMessageCode"></ActionParameter>
        </Action>

        <Action name="compareA4Receive" type="CompareClusterStats" thread="2">
            <ActionParameter name="structureID">stat_Cluster_A4</ActionParameter>
            <ActionParameter name="serverName">``A1_IPv4_HOSTNAME_1``</ActionParameter>
            <ObjectProperty name="ReadMsg" value="REGEXP: [1-9][0-9][0-9]+"/>
        </Action>

        <Action name="SyncWaitRMsPubd" type="SyncAction" thread="2">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">RMsPubd</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">60000</ActionParameter>
        </Action>

        <!-- take down a4 gracefully (shell action) -->
        <Action name="StopA4" type="ShellAction" thread="2">
            <dependsOn action_id="SyncWaitRMsPubd" interval="4000"/>
            <ActionParameter name="command">../scripts/cluster.py -a stopClusterMember -m 4 -v 2 -f testmqtt_clusterRM_001.stopA4.log</ActionParameter>
            <ActionParameter name="print_result">1</ActionParameter>
        </Action>

        <Action name="SetA4Stopped" type="SyncAction" thread="2">
            <ActionParameter name="request">set</ActionParameter>
            <ActionParameter name="condition">A4_Stopped</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
        </Action>


        <!-- Receive Messages-->
        <Action name="ReceiveMessagesA4" type="CompositeAction" repeat="1000000" atleast="5">
            <Action name="ReceiveMessage" type="ReceiveMessage">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">submsg1</ActionParameter>
                <ActionParameter name="waitTime">5000</ActionParameter>
            </Action>
        </Action>

        <!-- take out for now -->

        <!-- Once A3 removed from cluster, bring back A4 and subscribe to retained message topics -->
        <Action name="SyncWaitA3Removed" type="SyncAction" thread="2">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A3RemovedFromCluster</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>

        <Action name="StartA4" type="ShellAction" thread="2">
            <dependsOn action_id="SyncWaitA3Removed" interval="4000"/>
            <ActionParameter name="command">../scripts/cluster.py -a startClusterMember -m 4 -v 2 -f testmqtt_clusterRM_001.startA4.log</ActionParameter>
            <ActionParameter name="print_result">1</ActionParameter>
        </Action>

        <!-- Verify that there are no disconnected servers -->

        <Action name="restCheckDisconnectedServerCount-A4rj" type="RestAPI" thread="2">
            <dependsOn action_id="StartA4" interval="10000"/>
            <ActionParameter name="structureID">status_output4</ActionParameter>
            <ActionParameter name="server">``A4_HOST``:``A4_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/service/status</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
        </Action>

        <!-- verify that A3 does not show up in A4 cluster monitor -->
         <Action name="CheckA3goneClusterMonitor" type="RestAPI" thread="2" >
            <ActionParameter name="structureID">stat_Cluster_A4c</ActionParameter>
            <ActionParameter name="server">``A4_IPv4_1``:``A4_PORT``</ActionParameter>
            <ActionParameter name="path">/ima/v1/monitor/Cluster</ActionParameter>
            <ActionParameter name="action">GET</ActionParameter>
            <ActionParameter name="payload"></ActionParameter>
            <ActionParameter name="printResult">true</ActionParameter>
            <ActionParameter name="expectedStatusCode">200</ActionParameter>
            <ActionParameter name="expectedMessageCode"></ActionParameter>
        </Action>

        <Action name="checkDisconnectedServerCount-A4rj" type="CompareREST" thread="2">
            <ActionParameter name="structureID">status_output4</ActionParameter>
            <ActionParameter name="topLevelKey">Cluster</ActionParameter>
            <ActionParameter name="topLevelType">JSONObject</ActionParameter>
            <ObjectProperty name="DisconnectedServers" value="0"/>
            <!-- since a1 and a2 are the same machine in my tests, there is only 1 connected server - uncomment later-->
            <!-- <ObjectProperty name="ConnectedServers" value="2"/> -->
        </Action>

        <Action name="compareA3GoneFromCluster" type="CompareClusterStats" thread="2" rc="1" reason="ISMTEST3410">
            <ActionParameter name="structureID">stat_Cluster_A4c</ActionParameter>
            <ActionParameter name="serverName">``A4_IPv4_HOSTNAME_1``</ActionParameter>
            <ObjectProperty name="Status" value="Inactive"/>
        </Action>


        <Action name="CreateConnectionA4rejoin" type="CreateConnection" thread="2">
            <ActionParameter name="structure_id">Con1</ActionParameter>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <include>../common/ConnectionType.xml</include>
            <include>server4.xml</include>
            <ApiParameter name="clientId">RM_001_sub4-2</ApiParameter>
            <ApiParameter name="port">20005</ApiParameter>
            <ApiParameter name="protocol">mqtt</ApiParameter>
            <ApiParameter name="cleanSession">true</ApiParameter>
        </Action>

        <!-- Subscribe to RM topics on various qos levels-->


        <!-- Expect old messages -->
        <Action name="SubscribeToNewRMsA4-4" type="SubscribeTopicTree" thread="2">
            <dependsOn action_id="StartA4" interval="20000"/>
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">111</ActionParameter>
            <ActionParameter name="endIndex">120</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <!-- Receive -->
        <Action name="ReceiveRMsA4-1" type="CompositeAction" repeat="10" repeat_interval="0" thread="2">
            <Action name="ReceiveMessages-A4-RM-1" type="ReceiveMessage" >
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <!-- Old messages should start with "PublishToMany", new messages will start with NewMessage -->
            <Action name="CheckMessage-1" type="CompareMessageData">
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="compareBodyStart">PublishToMany</ActionParameter>
            </Action>
        </Action>

        <Action name="CheckNoMore1" type="ReceiveMessage" rc="1" reason="ISMTEST1143" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">newmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>

        <Action name="UnsubscribeToMany-2" type="UnsubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">101</ActionParameter>
            <ActionParameter name="endIndex">110</ActionParameter>
        </Action>



        <!-- Expect new messages -->
        <Action name="SubscribeToNewRMsA4-5" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">121</ActionParameter>
            <ActionParameter name="endIndex">130</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA4-6" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">131</ActionParameter>
            <ActionParameter name="endIndex">140</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA4-7" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">141</ActionParameter>
            <ActionParameter name="endIndex">150</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <Action name="ReceiveRMsA4-2" type="CompositeAction" repeat="30" repeat_interval="0" thread="2">
            <Action name="ReceiveMessages-A4-RM-2" type="ReceiveMessage" >
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <!-- Old messages should start with "PublishToMany", new messages will start with "NewMessage" -->
            <Action name="CheckMessage-2" type="CompareMessageData">
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="compareBodyStart">NewMessage</ActionParameter>
            </Action>
        </Action>

         <Action name="UnsubscribeToMany-3" type="UnsubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">111</ActionParameter>
            <ActionParameter name="endIndex">150</ActionParameter>
        </Action>

        <Action name="CheckNoMore2" type="ReceiveMessage" rc="1" reason="ISMTEST1143" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">newmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>




        <!-- Expect new messages (new topics) -->
        <Action name="SubscribeToNewRMsA4-8" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">151</ActionParameter>
            <ActionParameter name="endIndex">160</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA4-9" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">161</ActionParameter>
            <ActionParameter name="endIndex">165</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA4-10" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">166</ActionParameter>
            <ActionParameter name="endIndex">170</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>

        <Action name="ReceiveRMsA4-3" type="CompositeAction" repeat="20" repeat_interval="0" thread="2">
            <Action name="ReceiveMessages-A4-RM-3" type="ReceiveMessage" >
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">15000</ActionParameter>
            </Action>
            <!-- Old messages should start with "PublishToMany", new messages will start with "NewMessage" -->
            <Action name="CheckMessage-3" type="CompareMessageData">
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="compareBodyStart">NewMessage</ActionParameter>
            </Action>
        </Action>

        <Action name="UnsubscribeToMany-01" type="UnsubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">151</ActionParameter>
            <ActionParameter name="endIndex">170</ActionParameter>
        </Action>

        <Action name="CheckNoMore3" type="ReceiveMessage" rc="1" reason="ISMTEST1143" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="structure_id">newmsg1</ActionParameter>
            <ActionParameter name="waitTime">2000</ActionParameter>
        </Action>



        <!-- expect nulls -->
         <Action name="SubscribeToNewRMsA4-1" type="SubscribeTopicTree" thread="2">
            <!-- wait 15 seconds for servers to sync (sync interval=10s) -->
            <!-- <dependsOn action_id="StartA4" interval="20000"/> -->
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">101</ActionParameter>
            <ActionParameter name="endIndex">104</ActionParameter>
            <ActionParameter name="qos">0</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA4-2" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">105</ActionParameter>
            <ActionParameter name="endIndex">108</ActionParameter>
            <ActionParameter name="qos">1</ActionParameter>
        </Action>
        <Action name="SubscribeToNewRMsA4-3" type="SubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">109</ActionParameter>
            <ActionParameter name="endIndex">110</ActionParameter>
            <ActionParameter name="qos">2</ActionParameter>
        </Action>
        <!-- Expect null -->
        <Action name="ReceiveNewRMs-1" type="CompositeAction" repeat="1" repeat_interval="0" thread="2">
            <Action name="ReceiveNulls" type="ReceiveMessage" rc="1" reason="ISMTEST1143">
                <ActionParameter name="connection_id">CF1</ActionParameter>
                <ActionParameter name="structure_id">newmsg1</ActionParameter>
                <ActionParameter name="waitTime">2000</ActionParameter>
            </Action>
        </Action>

        <Action name="UnsubscribeToMany-1" type="UnsubscribeTopicTree" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
            <ActionParameter name="prefix">/AdmRm_001/</ActionParameter>
            <ActionParameter name="startIndex">101</ActionParameter>
            <ActionParameter name="endIndex">110</ActionParameter>
        </Action>


        <!-- Sets A4_verified which triggers close connections -->
        <Action name="SetA4Verified" type="SyncAction" thread="2">
            <!-- <dependsOn action_id="SyncWaitA3Removed" interval="10000"/> -->
            <ActionParameter name="request">set</ActionParameter>
            <ActionParameter name="condition">A4_verified</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
        </Action>

        <!-- Wait for A4 Verified then disconnect -->
        <Action name="SyncReadyToCloseA4S" type="SyncAction" thread="2">
            <ActionParameter name="request">wait</ActionParameter>
            <ActionParameter name="condition">A4_verified</ActionParameter>
            <ActionParameter name="value">1</ActionParameter>
            <ActionParameter name="timeout">120000</ActionParameter>
        </Action>

        <Action name="CloseConnectionA4" type="CloseConnection" thread="2">
            <ActionParameter name="connection_id">CF1</ActionParameter>
        </Action>


    </Action>



</IsmWSTest>
