<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>SpiderCast C++: The Membership Service</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SpiderCast C++
   &#160;<span id="projectnumber">0.3.2</span>
   </div>
   <div id="projectbrief">Scalable Membership and Group Communication Services</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">SpiderCast (C++) User Manual</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The Membership Service </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="mem_service_sec"></a>
Function</h1>
<p>The access point to the membership service is the <a class="el" href="classspdr_1_1_membership_service.html">MembershipService </a> interface. An implementation of this interface is created by calling <a class="el" href="classspdr_1_1_spider_cast.html#a02a125db5f7c1b114ae9cc7f1ff4c8e1">SpiderCast#createMembershipService() </a>. In the creation process the user essentially registers an event listener (an implementation of the <a class="el" href="classspdr_1_1_membership_listener.html">MembershipListener </a> interface), which is then used by SpiderCast to deliver membership events to the user.</p>
<p>The membership events first deliver the full membership view, by a <a class="el" href="classspdr_1_1event_1_1_view_change_event.html">ViewChangeEvent </a>, followed by differential updates to the membership. That is, when a new node starts and joins the overlay, a <a class="el" href="classspdr_1_1event_1_1_node_join_event.html">NodeJoinEvent </a> is delivered. When a node closes or fails, a <a class="el" href="classspdr_1_1event_1_1_node_leave_event.html">NodeLeaveEvent </a> is delivered. These events carry the respective node identifier (<a class="el" href="classspdr_1_1_node_i_d.html">NodeID </a>).</p>
<h1><a class="anchor" id="mebership_example_sec"></a>
Example</h1>
<p>The following code snippet demonstrates how to create the membership service. Creation is allowed only after the node has been started.</p>
<div class="fragment"><div class="line"><span class="comment">//create and start the node (see previous example)</span></div>
<div class="line">spidercast_SPtr-&gt;start();</div>
<div class="line"><span class="comment">//create a simple membership listener (see below)</span></div>
<div class="line">ViewKeeper memListener(spidercast_SPtr-&gt;getNodeID());</div>
<div class="line"><span class="comment">//create the membership service</span></div>
<div class="line">PropertyMap prop;</div>
<div class="line"><a class="code" href="namespacespdr.html#a687e0bd91de7a40fb292af73e1c6bc88">MembershipService_SPtr</a> memService_SPtr =</div>
<div class="line">  spidercast_SPtr-&gt;createMembershipService(prop,memListener);</div>
<div class="line"><span class="comment">//from this moment on, membership events start flowing through the listener</span></div>
<div class="line"><span class="comment">//let it work for a while</span></div>
<div class="line">boost::this_thread::sleep(boost::posix_time::seconds(60));</div>
<div class="line"><span class="comment">//close the membership service</span></div>
<div class="line">memService_SPtr-&gt;close();</div>
<div class="line"><span class="comment">//close the node</span></div>
<div class="line">spidercast_SPtr-&gt;close(<span class="keyword">true</span>);</div>
</div><!-- fragment --><p>Here is a simple example of a membership listener implementation. This class maintains an internal set of live nodes (a view), and allows another thread to get a copy of the view. This code is thread safe.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>spdr {</div>
<div class="line"><span class="keyword">class </span>ViewKeeper: <span class="keyword">public</span> MembershipListener {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="comment">//the view, a set of NodeID (shared-pointer)</span></div>
<div class="line">  std::set&lt;NodeID_SPtr&gt; view_;</div>
<div class="line">  <a class="code" href="namespacespdr.html#acfb3849e5f7b7ffbc63e4ef2cb11a9f6" title="A shared pointer to a NodeID.">NodeID_SPtr</a> myNodeID_;</div>
<div class="line">  <span class="keyword">mutable</span> boost::recursive_mutex mutex_;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  ViewKeeper(<a class="code" href="namespacespdr.html#acfb3849e5f7b7ffbc63e4ef2cb11a9f6" title="A shared pointer to a NodeID.">NodeID_SPtr</a> myNodeID) : myNodeID_(myNodeID) {}</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> ~ViewKeeper() {}</div>
<div class="line"></div>
<div class="line">  <span class="comment">//process membership events</span></div>
<div class="line">  <span class="keywordtype">void</span> onMembershipEvent(<a class="code" href="namespacespdr_1_1event.html#aa0e3e31f7cf429da0edae2e47e5ac375" title="A boost::shared_ptr to a MembershipEvent.">event::MembershipEvent_SPtr</a> event) {</div>
<div class="line">    <span class="keywordflow">if</span> (event) {</div>
<div class="line">      std::cout &lt;&lt; myNodeID_-&gt;toString() &lt;&lt; <span class="stringliteral">&quot; : &quot;</span></div>
<div class="line">        &lt;&lt; <span class="keyword">event</span>-&gt;toString() &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">switch</span> (event-&gt;getType())</div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546ea4992e2512d4cb59cd8593dbfd5846ce9" title="View Change (membership events)">event::View_Change</a>:</div>
<div class="line">         { <span class="comment">//the first view</span></div>
<div class="line">           boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">           <a class="code" href="namespacespdr_1_1event.html#a1e7b81ff9d18a060b969552f3af42255" title="A boost::shared_ptr to a ViewChangeEvent.">event::ViewChangeEvent_SPtr</a> vcp = boost::static_pointer_cast&lt;</div>
<div class="line">             event::ViewChangeEvent&gt;(event);</div>
<div class="line">           <span class="keywordflow">for</span> (event::ViewMap::const_iterator it =</div>
<div class="line">             vcp-&gt;getView()-&gt;begin(); it != vcp-&gt;getView()-&gt;end(); ++it) {</div>
<div class="line">               view_.insert(it-&gt;first);</div>
<div class="line">           }</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546eac6333602c74a09146baec8781d22d015" title="Node_Join (membership events)">event::Node_Join</a>:</div>
<div class="line">        { <span class="comment">//insert to the view</span></div>
<div class="line">          boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">          <a class="code" href="namespacespdr_1_1event.html#a4b69f009be59f3fce4d704d40674f701" title="A boost::shared_ptr to a NodeJoinEvent.">event::NodeJoinEvent_SPtr</a> njp = boost::static_pointer_cast&lt;</div>
<div class="line">            event::NodeJoinEvent&gt;(event);</div>
<div class="line">          view_.insert(njp-&gt;getNodeID());</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546ea05604cf107e4fad63e6df5e3f78f3e00" title="Node_Leave (membership events)">event::Node_Leave</a>:</div>
<div class="line">         { <span class="comment">//remove from view</span></div>
<div class="line">           boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">           <a class="code" href="namespacespdr_1_1event.html#a401cd3ddbd976590a75a4d1c9e593399" title="A boost::shared_ptr to a NodeLeaveEvent.">event::NodeLeaveEvent_SPtr</a> nlp = boost::static_pointer_cast&lt;</div>
<div class="line">             event::NodeLeaveEvent&gt;(event);</div>
<div class="line">           view_.erase(nlp-&gt;getNodeID());</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546ea84e6e29442cb3b0a3d2787a099bb99c0" title="Change_of_Metadata (membership events)">event::Change_of_Metadata</a>:</div>
<div class="line">         {</div>
<div class="line">           <span class="comment">//update meta-data, ignore (see next section)</span></div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line">       }</div>
<div class="line">     }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">//allow another thread to get a copy of the view</span></div>
<div class="line">  std::set&lt;NodeID_SPtr&gt; getView() {</div>
<div class="line">    std::set&lt;NodeID_SPtr&gt; copy;</div>
<div class="line">    {</div>
<div class="line">      boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">      copy-&gt;insert(view_.begin(), view_.end());</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> copy;</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that these code snippets avoid some boiler-plate code and error paths.</p>
<hr/>
 <a class="el" href="attr_service_page.html">Next</a>: The Attribute Service </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 30 2012 15:33:38 for SpiderCast C++ by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
