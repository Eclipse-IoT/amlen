<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>SpiderCast C++: The Attribute Replication Service</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">SpiderCast C++
   &#160;<span id="projectnumber">0.3.2</span>
   </div>
   <div id="projectbrief">Scalable Membership and Group Communication Services</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">SpiderCast (C++) User Manual</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The Attribute Replication Service </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="attr_service_sec"></a>
Function</h1>
<p>The attribute service is integrated with the membership service. Creating the MembershipService object provides access to the attribute service as well.</p>
<p>Each node has an internal map of attributes only it can write. A single attribute is a key-value pair, where keys are Strings and the values are byte buffers. This map is replicated to all other nodes in the overlay.</p>
<p>The MembershipService interface has methods for manipulating the node's (self) attribute map, for example: </p>
<ul>
<li>
<a class="el" href="classspdr_1_1_membership_service.html#a19797f4d3b1a0db24d72e0d98c852465">MembershipService::setAttribute() </a> </li>
<li>
<a class="el" href="classspdr_1_1_membership_service.html#a6e079745e8adbc409d9d886696492135">MembershipService::removeAttribute() </a> </li>
<li>
<a class="el" href="classspdr_1_1_membership_service.html#a76ca5a96fffb4a9f72e47a08db852006">MembershipService::getAttribute() </a> </li>
</ul>
<p>Membership events carry, along with each node identifier, an object that encapsulates meta-data about the node. The attribute map of a node is delivered as a member of the <a class="el" href="classspdr_1_1event_1_1_meta_data.html">MetaData </a> object. Thus, when a node joins the overlay, the NodeJoinEvent also carries that node's <a class="el" href="classspdr_1_1event_1_1_attribute_map.html">AttributeMap. </a></p>
<p>When an existing node changes its attribute map, the change is propagated and subsequently delivered to all other nodes with a <a class="el" href="classspdr_1_1event_1_1_change_of_meta_data_event.html">ChangeOfMetaDataEvent </a> event, that carries the updated attribute map and the respective node identifier.</p>
<h1><a class="anchor" id="Example"></a>
Example</h1>
<p>This code snippet show a membership listener that accumulates the node membership view together with the meta-data, in an internal map. The node also allows another thread to get a copy of the augmented view.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>spdr {</div>
<div class="line"><span class="keyword">class </span>ViewKeeper2: <span class="keyword">public</span> MembershipListener {</div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">  <span class="comment">//the view, a map of NodeID (shared-pointer) and MetaData (shared-pointer) pairs</span></div>
<div class="line">  <span class="comment">//this is a shared-pointer to the map</span></div>
<div class="line">  <a class="code" href="namespacespdr_1_1event.html#a02d9302846d76e995133fb4d108355cb" title="A boost::shared_ptr to a ViewMap.">event::ViewMap_SPtr</a> view_SPtr;</div>
<div class="line">  <a class="code" href="namespacespdr.html#acfb3849e5f7b7ffbc63e4ef2cb11a9f6" title="A shared pointer to a NodeID.">NodeID_SPtr</a> myNodeID_;</div>
<div class="line">  <span class="keyword">mutable</span> boost::recursive_mutex mutex_;</div>
<div class="line"></div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SCViewKeeper2(<a class="code" href="namespacespdr.html#acfb3849e5f7b7ffbc63e4ef2cb11a9f6" title="A shared pointer to a NodeID.">NodeID_SPtr</a> myNodeID) : myNodeID_(myNodeID) {}</div>
<div class="line"></div>
<div class="line">  <span class="keyword">virtual</span> ~SCViewKeeper2() {}</div>
<div class="line"></div>
<div class="line">  <span class="comment">//process membership events</span></div>
<div class="line">  <span class="keywordtype">void</span> onMembershipEvent(<a class="code" href="namespacespdr_1_1event.html#aa0e3e31f7cf429da0edae2e47e5ac375" title="A boost::shared_ptr to a MembershipEvent.">event::MembershipEvent_SPtr</a> event) {</div>
<div class="line">    <span class="keywordflow">if</span> (event) {</div>
<div class="line">      std::cout &lt;&lt; myNodeID_-&gt;toString() &lt;&lt; <span class="stringliteral">&quot; : &quot;</span></div>
<div class="line">        &lt;&lt; <span class="keyword">event</span>-&gt;toString() &lt;&lt; std::endl;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">switch</span> (event-&gt;getType())</div>
<div class="line">      {</div>
<div class="line">         <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546ea4992e2512d4cb59cd8593dbfd5846ce9" title="View Change (membership events)">event::View_Change</a>:</div>
<div class="line">         { <span class="comment">//the first view</span></div>
<div class="line">           boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">           <a class="code" href="namespacespdr_1_1event.html#a1e7b81ff9d18a060b969552f3af42255" title="A boost::shared_ptr to a ViewChangeEvent.">event::ViewChangeEvent_SPtr</a> vcp = boost::static_pointer_cast&lt;</div>
<div class="line">             event::ViewChangeEvent&gt;(event);</div>
<div class="line">           view_SPtr = vcp-&gt;getView();</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546eac6333602c74a09146baec8781d22d015" title="Node_Join (membership events)">event::Node_Join</a>:</div>
<div class="line">        { <span class="comment">//insert to the view</span></div>
<div class="line">          boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">          <a class="code" href="namespacespdr_1_1event.html#a4b69f009be59f3fce4d704d40674f701" title="A boost::shared_ptr to a NodeJoinEvent.">event::NodeJoinEvent_SPtr</a> njp = boost::static_pointer_cast&lt;</div>
<div class="line">            event::NodeJoinEvent&gt;(event);</div>
<div class="line">          view_SPtr-&gt;insert(event::ViewMap::value_type(</div>
<div class="line">            njp-&gt;getNodeID(), njp-&gt;getMetaData())); <span class="comment">//keep meta-data</span></div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546ea05604cf107e4fad63e6df5e3f78f3e00" title="Node_Leave (membership events)">event::Node_Leave</a>:</div>
<div class="line">         { <span class="comment">//remove from view</span></div>
<div class="line">           boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">           <a class="code" href="namespacespdr_1_1event.html#a401cd3ddbd976590a75a4d1c9e593399" title="A boost::shared_ptr to a NodeLeaveEvent.">event::NodeLeaveEvent_SPtr</a> nlp = boost::static_pointer_cast&lt;</div>
<div class="line">             event::NodeLeaveEvent&gt;(event);</div>
<div class="line">           view_SPtr-&gt;erase(nlp-&gt;getNodeID());</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">         <span class="keywordflow">case</span> <a class="code" href="namespacespdr_1_1event.html#a76f4860bbc41c8251a073d91e633546ea84e6e29442cb3b0a3d2787a099bb99c0" title="Change_of_Metadata (membership events)">event::Change_of_Metadata</a>:</div>
<div class="line">         { <span class="comment">//update meta-data</span></div>
<div class="line">           boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">           <a class="code" href="namespacespdr_1_1event.html#a37ff681ebda2e1a5e391f9607bff5f5c" title="A boost::shared_ptr to a ChangeOfMetaDataEvent.">event::ChangeOfMetaDataEvent_SPtr</a> cmp = boost::static_pointer_cast&lt;</div>
<div class="line">             event::ChangeOfMetaDataEvent&gt;(event);</div>
<div class="line">           <a class="code" href="namespacespdr_1_1event.html#a02d9302846d76e995133fb4d108355cb" title="A boost::shared_ptr to a ViewMap.">event::ViewMap_SPtr</a> partial_view_SPtr = cmp-&gt;getView();</div>
<div class="line"></div>
<div class="line">           <span class="keywordflow">for</span> (event::ViewMap::const_iterator it =</div>
<div class="line">             partial_view_SPtr-&gt;begin(); it != partial_view_SPtr-&gt;end(); ++it) {</div>
<div class="line">               <span class="comment">//update only nodes that have changed their meta-data</span></div>
<div class="line">               event::ViewMap::iterator res = view_SPtr-&gt;find(it-&gt;first);</div>
<div class="line">               res-&gt;second = it-&gt;second;</div>
<div class="line">           }</div>
<div class="line">         }</div>
<div class="line">         <span class="keywordflow">break</span>;</div>
<div class="line">       }</div>
<div class="line">     }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">//allow another thread to get a copy of the view</span></div>
<div class="line">  <a class="code" href="namespacespdr_1_1event.html#a02d9302846d76e995133fb4d108355cb" title="A boost::shared_ptr to a ViewMap.">event::ViewMap_SPtr</a> getView() {</div>
<div class="line">    <a class="code" href="namespacespdr_1_1event.html#a02d9302846d76e995133fb4d108355cb" title="A boost::shared_ptr to a ViewMap.">event::ViewMap_SPtr</a> copy;</div>
<div class="line">    {</div>
<div class="line">      boost::recursive_mutex::scoped_lock lock(mutex_);</div>
<div class="line">      <span class="keywordflow">if</span> (view_SPtr) {</div>
<div class="line">        copy.reset(<span class="keyword">new</span> <a class="code" href="namespacespdr_1_1event.html#a93ab8d7fd108603478b968b59b40fed8" title="A map that holds the node membership view.">event::ViewMap</a>);</div>
<div class="line">        copy-&gt;insert(view_SPtr-&gt;begin(), view_SPtr-&gt;end());</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> copy;</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that these code snippets avoid some boiler-plate code and error paths.</p>
<hr/>
 <a class="el" href="pubsub_service_page.html">Next</a>: The Publish-Subscribe Service </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 30 2012 15:33:38 for SpiderCast C++ by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
